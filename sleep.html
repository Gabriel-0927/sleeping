<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â§¢Â¢ÉÈÅäÊà≤ - ÁôæÊó•Â§¢</title>
    
    <style>
        :root { --dark-bg: #1a1a2e; --container-bg: #16213e; --border-color: #0f3460; --primary-text: #e0e0e0; --highlight-color: #e94560; --good-color: #3f72af; --bad-color: #d9534f; --neutral-color: #f0ad4e; }
        body { font-family: 'Microsoft JhengHei', 'Arial', sans-serif; background-color: var(--dark-bg); color: var(--primary-text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        #game-container { position: relative; width: 90%; max-width: 700px; background-color: var(--container-bg); padding: 25px; border-radius: 15px; box-shadow: 0 0 20px rgba(255, 255, 255, 0.1); border: 1px solid var(--border-color); transition: filter 0.3s, transform 0.3s; z-index: 10; }
        #game-container.frozen { filter: blur(5px); transform: scale(0.98); pointer-events: none; }
        h1, h2 { text-align: center; color: var(--highlight-color); text-shadow: 0 0 5px var(--highlight-color); }
        #player-stats { display: flex; justify-content: space-around; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; font-size: 1.1em; flex-wrap: wrap; }
        #game-log { background-color: #0f1c2e; border: 1px solid var(--border-color); padding: 15px; height: 150px; overflow-y: scroll; margin-bottom: 20px; border-radius: 5px; scroll-behavior: smooth; }
        button { padding: 12px 25px; font-size: 18px; font-weight: bold; cursor: pointer; border: none; border-radius: 8px; background-color: var(--highlight-color); color: white; transition: background-color 0.3s, transform 0.1s; user-select: none; -webkit-tap-highlight-color: transparent; }
        button:disabled { background-color: #555; cursor: not-allowed; opacity: 0.7; }
        button:not(:disabled):active { transform: translateY(1px); }
        .upgrade-item { background-color: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); padding: 15px; margin-bottom: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .upgrade-item div { flex-basis: 70%; } .upgrade-item button { flex-basis: 25%; } .upgrade-item p { margin: 2px 0; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; background-color: rgba(0, 0, 0, 0.7); }
        .modal:not(.hidden) { opacity: 1; pointer-events: all; }
        .modal-content { background-color: var(--container-bg); padding: 30px; border-radius: 15px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; text-align: center; transform: scale(0.9); transition: transform 0.3s; position: relative; }
        .modal:not(.hidden) .modal-content { transform: scale(1); }
        #minigame-instruction, #event-instruction { min-height: 20px; color: var(--neutral-color); margin-top: 0; }
        #minigame-info-bar { display: flex; justify-content: space-around; font-size: 1.2em; font-weight: bold; margin-bottom: 15px; min-height: 25px; }
        #minigame-area { position: relative; width: 100%; height: 250px; background-color: #0f1c2e; border-radius: 10px; margin: 15px 0; overflow: hidden; user-select: none; }
        #minigame-result { font-size: 1.5em; margin-top: 20px; font-weight: bold; min-height: 50px; transition: color 0.3s; }
        #potion-effect-status { text-align: center; color: var(--neutral-color); min-height: 20px; margin-bottom: 15px; font-weight: bold; }
        #settings-area { position: absolute; top: 15px; right: 15px; }
        #settings-button { font-size: 1.2em; padding: 5px 10px; background: none; border: 1px solid var(--border-color); }
        #story-modal-text { font-size: 1.2em; line-height: 1.6; margin-bottom: 25px; }
        #ending-modal .modal-content { background: linear-gradient(180deg, #1a1a2e, #0f1c2e); border-color: #e94560; }
        #ending-title { font-size: 2.5em; color: var(--highlight-color); }
        #ending-text { font-size: 1.2em; margin: 20px 0; }
        #ending-buttons { display: flex; justify-content: center; gap: 20px; margin-top: 25px; }
        #ending-continue-button { background-color: var(--good-color); }
        #backpack-items .upgrade-item div { flex-basis: 60%; }
        #backpack-items .upgrade-item button { flex-basis: 35%; }
        #mobile-controls-container { display: none; margin-top: 15px; }
        #mobile-controls-container.visible { display: flex; justify-content: space-around; align-items: center; }
        .mobile-btn { flex-grow: 1; margin: 0 5px; padding: 15px 10px; font-size: 2em; background-color: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.4); }
        #mobile-hold-button { width: 80%; padding: 20px; font-size: 1.5em; background-color: var(--good-color); }
        .meteor { position: fixed; font-size: 2em; color: yellow; text-shadow: 0 0 10px orange; user-select: none; pointer-events: auto; cursor: pointer; z-index: 1002; } @keyframes fall-meteor { 0% { transform: translate(0, 0) rotate(-45deg); opacity: 1; } 100% { transform: translate(-100vw, 100vh) rotate(-45deg); opacity: 0; } } #card-container { display: flex; justify-content: space-around; perspective: 1000px; margin-top: 20px; } .card { width: 100px; height: 150px; cursor: pointer; } .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; } .card.is-flipped .card-inner { transform: rotateY(180deg); } .card-face { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px; box-sizing: border-box; } .card-back { background: linear-gradient(45deg, #6d6d6d, #4f4f4f); font-size: 3em; color: var(--neutral-color); } .card-front { background-color: #eee; color: #333; transform: rotateY(180deg); } .fortune-name { font-size: 2em; font-weight: bold; } .fortune-tagline { font-size: 0.9em; margin-top: 10px; } .star { position: absolute; font-size: 3em; cursor: pointer; user-select: none; } .emotion-icon { position: absolute; font-size: 3.5em; cursor: pointer; user-select: none; animation: fall linear forwards; } .star.popped, .emotion-icon.popped, .fish.popped, .meteor.popped { animation: pop 0.3s ease-out forwards; } @keyframes pop { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } } @keyframes fall { 0% { top: -50px; } 100% { top: 250px; } }
        #qte-timer-bar-container { width: 100%; height: 10px; background-color: #555; border-radius: 5px; margin-top: 10px; } #qte-timer-bar { width: 100%; height: 100%; background-color: var(--neutral-color); border-radius: 5px; transition: width 2s linear; } .screen-flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1001; pointer-events: none; animation: flash-anim 0.4s ease-out; } @keyframes flash-anim { from { opacity: 0.7; } to { opacity: 0; } } #player-avatar, .shadow-obstacle { position: absolute; } #player-avatar { bottom: 10px; width: 30px; height: 30px; background-color: var(--good-color); border-radius: 50%; box-shadow: 0 0 10px white; } #player-avatar.hit { animation: player-hit 0.5s; } @keyframes player-hit { 50% { background-color: var(--bad-color); transform: scale(1.2); } } .shadow-obstacle { width: 40px; height: 40px; background-color: #444; border-radius: 10px; animation: fall linear forwards; } .fishing-line { position: absolute; width: 2px; height: 0; background-color: white; top: 0; left: 50%; transition: height 0.3s ease-out; } .fish { position: absolute; font-size: 2em; } .memory-star { position: absolute; font-size: 2.5em; cursor: pointer; transition: transform 0.2s, text-shadow 0.2s; } .memory-star.highlight { text-shadow: 0 0 15px yellow; transform: scale(1.3); } .memory-star.wrong { animation: flash-red 0.5s; } .memory-star.correct-path { animation: flash-green 0.5s; } @keyframes flash-red { 50% { text-shadow: 0 0 15px red; } } @keyframes flash-green { 50% { text-shadow: 0 0 15px lightgreen; } } .dream-fragment { position: absolute; width: 40px; height: 40px; background-color: rgba(255, 255, 255, 0.1); border: 2px solid var(--neutral-color); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5em; cursor: pointer; transition: background-color 0.2s; } .dream-fragment.clicked { background-color: var(--good-color); border-color: lightgreen; } #paralysis-bar-container { width: 80%; height: 40px; background-color: #0f1c2e; border: 2px solid #555; border-radius: 10px; margin: 50px auto; } #paralysis-bar { width: 0%; height: 100%; background-color: var(--good-color); border-radius: 8px; transition: width 0.1s linear; } #paralysis-pulse { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(217, 83, 79, 0.7); opacity: 0; animation: pulse-anim 1.5s ease-in-out infinite; } @keyframes pulse-anim { 5% { opacity: 1; } 25% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="settings-area">
            <button id="settings-button">‚öôÔ∏è</button>
        </div>
        <h1>Â§¢Â¢ÉÈÅäÊà≤</h1>
        <div id="player-stats">
            <p>Â§©Êï∏: <span id="day-count">0</span> ‚òÄÔ∏è</p>
            <p>ÈáëÈå¢: <span id="money">0</span> üí∞</p>
            <p>Â•ΩÂ§¢Ê©üÁéá: <span id="good-dream-chance">50</span>% ‚ú®</p>
        </div>
        <div id="potion-effect-status"></div>
        <div id="game-log"></div>
        <div id="controls" style="text-align:center; margin-bottom:25px; display: flex; justify-content: center; gap: 20px;">
            <button id="sleep-button">ÂÖ•Áù°</button>
            <button id="backpack-button" style="background-color: var(--good-color);">ËÉåÂåÖ</button>
        </div>
        <div id="upgrades">
            <h2>ÂçáÁ¥öÂïÜÂ∫ó</h2>
            <div class="upgrade-item">
                <div>
                    <p><strong>ÂçáÁ¥öÂ∫ä</strong> (Á≠âÁ¥ö: <span id="bed-level">1</span>)</p>
                    <p>ÊïàÊûú: +5% Âü∫Á§éÂ•ΩÂ§¢Ê©üÁéá (‰∏äÈôê95%)</p>
                    <p>ÂÉπÊ†º: <span id="bed-upgrade-cost">50</span> üí∞</p>
                </div>
                <button id="upgrade-bed-button">ÂçáÁ¥ö</button>
            </div>
             <div class="upgrade-item">
                <div>
                    <p><strong>ÂçáÁ¥öÊûïÈ†≠</strong> (Á≠âÁ¥ö: <span id="pillow-level">1</span>)</p>
                    <p>ÊïàÊûú: ÊèêÈ´òÈáëÈå¢Áç≤ÂèñÈáè</p>
                    <p>ÂÉπÊ†º: <span id="pillow-upgrade-cost">70</span> üí∞</p>
                </div>
                <button id="upgrade-pillow-button">ÂçáÁ¥ö</button>
            </div>
            <div class="upgrade-item">
                <div>
                    <p><strong>Ë≥ºË≤∑ÊçïÂ§¢Á∂≤</strong> (Á≠âÁ¥ö: <span id="dreamcatcher-level">1</span>)</p>
                    <p>ÊïàÊûú: Ê∏õÂ∞ëÂ£ûÂ§¢ÁöÑÈáëÈå¢ÊêçÂ§± (ÊØèÁ¥ö-10%)</p>
                    <p>ÂÉπÊ†º: <span id="dreamcatcher-upgrade-cost">100</span> üí∞</p>
                </div>
                <button id="upgrade-dreamcatcher-button">ÂçáÁ¥ö</button>
            </div>
            <div class="upgrade-item">
                <div>
                    <p><strong>Ë≥ºË≤∑ÂØßÁ•ûËñ∞È¶ô</strong> (Á≠âÁ¥ö: <span id="incense-level">1</span>)</p>
                    <p>ÊïàÊûú: Âª∂Èï∑Â•ΩÂ§¢ÊôÇÈñì / Èôç‰ΩéÂ£ûÂ§¢Èõ£Â∫¶</p>
                    <p>ÂÉπÊ†º: <span id="incense-upgrade-cost">120</span> üí∞</p>
                </div>
                <button id="upgrade-incense-button">ÂçáÁ¥ö</button>
            </div>
        </div>
        <div id="item-shop">
            <h2>Áâ©ÂìÅÂïÜÂ∫ó</h2>
            <div class="upgrade-item">
                <div>
                    <p><strong>Âπ∏ÈÅãÂõõËëâËçâ</strong> (ÊïàÊûú: ‰∏ãÊ¨°ÂøÖÂÆöÂ•ΩÂ§¢)</p>
                    <p>ÂÉπÊ†º: <span id="good-dream-item-cost">150</span> üí∞</p>
                </div>
                <button id="buy-good-dream-item-button">Ë≥ºË≤∑</button>
            </div>
            <div class="upgrade-item">
                <div>
                    <p><strong>Ë©õÂííÂ®ÉÂ®É</strong> (ÊïàÊûú: ‰∏ãÊ¨°ÂøÖÂÆöÂ£ûÂ§¢)</p>
                    <p>ÂÉπÊ†º: <span id="bad-dream-item-cost">50</span> üí∞</p>
                </div>
                <button id="buy-bad-dream-item-button">Ë≥ºË≤∑</button>
            </div>
        </div>
    </div>
    
    <div id="minigame-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="minigame-title"></h3>
            <p id="minigame-instruction"></p>
            <div id="minigame-info-bar"></div>
            <div id="minigame-area"></div>
            <div id="minigame-result"></div>
            <div id="mobile-controls-container"></div>
        </div>
    </div>

    <div id="event-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="event-title">Â§¢Â¢ÉÁöÑÂïüÁ§∫</h3>
            <p id="event-instruction">‰ºº‰πéÊúâ‰ªÄÈ∫º‰∫ãË¶ÅÁôºÁîü‰∫Ü... Ë´ãÈÅ∏Êìá‰∏ÄÂºµÂç°ÁâåÔºåÁúãÁúã‰Ω†ÁöÑÈÅãÂã¢„ÄÇ</p>
            <div id="card-container"></div>
            <p id="event-result" style="font-size: 1.2em; min-height: 40px; margin-top: 20px;"></p>
        </div>
    </div>

    <div id="merchant-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Á•ûÁßòÁöÑÂ§¢Â¢ÉÂïÜ‰∫∫Âá∫Áèæ‰∫ÜÔºÅ</h3>
            <p>‰ªñÂ∞áÂú® <span id="merchant-timer"></span> ÁßíÂæåÈõ¢Âéª...</p>
            <div id="merchant-items"></div>
        </div>
    </div>

    <div id="story-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="story-modal-title"></h3>
            <p id="story-modal-text"></p>
            <button id="story-modal-close-button">ÁπºÁ∫å</button>
        </div>
    </div>

    <div id="ending-modal" class="modal hidden">
        <div class="modal-content">
            <h2 id="ending-title">Á¨¨‰∏ÄÁØáÁ´†„ÉªÂÆå</h2>
            <p id="ending-text">ÊÑüË¨ùÊÇ®ÁöÑÈÅäÁé©ÔºÅË´ãÈùúÂæÖÁ¨¨‰∫åÁØáÁ´†ÁöÑÊõ¥Êñ∞...</p>
            <div id="ending-buttons">
                <button id="ending-continue-button">ÁπºÁ∫åÈÅäÁé©</button>
                <button id="ending-reset-button">ÈáçÊñ∞ÈñãÂßã</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Ë®≠ÂÆö</h2>
            <p>ÊÇ®Á¢∫ÂÆöË¶ÅÂà™Èô§ÊâÄÊúâÈÄ≤Â∫¶ÔºåÂõûÂà∞Á¨¨‰∏ÄÂ§©ÂóéÔºüÊ≠§Âãï‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ</p>
            <button id="delete-save-button" style="background-color: var(--bad-color);">Âà™Èô§Â≠òÊ™î‰∏¶ÈáçÁΩÆ</button>
            <button id="settings-close-button" style="background-color: #555; margin-top: 10px;">ÂèñÊ∂à</button>
        </div>
    </div>

    <div id="backpack-modal" class="modal hidden">
        <div class="modal-content">
            <h2>ËÉåÂåÖ</h2>
            <div id="backpack-items" style="max-height: 400px; overflow-y: auto; padding: 10px;"></div>
            <button id="backpack-close-button" style="background-color: #555; margin-top: 20px;">ÈóúÈñâ</button>
        </div>
    </div>

    <script>
    // --- 1. ÈÅäÊà≤ÁãÄÊÖãËàáË®≠ÂÆö ---
    let dayCount, money, baseGoodDreamChance, pillowLevel, dreamCatcherLevel, incenseLevel, bedLevel;
    let bedUpgradeCost, pillowUpgradeCost, dreamCatcherUpgradeCost, incenseUpgradeCost;
    let inventory, gameLogHTML, tempGoodDreamChanceBonus;
    let effectNextGoodDream = false, effectNextBadDream = false, activePotion = null; 

    const goodDreamItemCost = 150, badDreamItemCost = 50;
    const isTouchDevice = 'ontouchstart' in window;
    let mainScreenEventActive = false, minigameActive = false, eventActive = false, storyModalActive = false, endingActive = false, settingsModalActive = false, backpackModalActive = false;
    let gameInterval, gameTimeout, keydownHandler, keyupHandler, mousemoveHandler, touchMoveHandler, touchStartHandler, touchEndHandler, mainEventInterval;

    const itemsData = { 'luckyClover': { name: 'Âπ∏ÈÅãÂõõËëâËçâ', description: '‰ΩøÁî®ÂæåÔºå‰∏ãÊ¨°ÂÖ•Áù°ÂøÖÂÆöÊòØÂ•ΩÂ§¢„ÄÇ' }, 'cursedDoll': { name: 'Ë©õÂííÂ®ÉÂ®É', description: '‰ΩøÁî®ÂæåÔºå‰∏ãÊ¨°ÂÖ•Áù°ÂøÖÂÆöÊòØÂ£ûÂ§¢„ÄÇ' }, 'power': { name: 'ÂäõÈáèËó•Ê∞¥', description: '‰∏ãÊ¨°Â§¢Â¢ÉÈáëÈå¢Áç≤ÂèñÈáèÂä†ÂÄçÔºå‰ΩÜÂ•ΩÂ§¢Ê©üÁéáÊ∏õÂçä„ÄÇ', effect: { moneyMultiplier: 2, goodChanceMultiplier: 0.5 } }, 'peace': { name: 'ÂÆâÁ•ûËó•Ê∞¥', description: '‰∏ãÊ¨°Â§¢Â¢ÉÂøÖÂÆöÊàêÂäüÔºå‰ΩÜÈáëÈå¢Áç≤ÂèñÈáèÊ∏õÂçä„ÄÇ', effect: { moneyMultiplier: 0.5, forceSuccess: true } }, 'greed': { name: 'Ë≤™Â©™Ëó•Ê∞¥', description: '‰∏ãÊ¨°Â§¢Â¢ÉÈáëÈå¢Áç≤ÂèñÈáèËÆäÁÇ∫‰∏âÂÄçÔºå‰ΩÜÂøÖÂÆöÊòØÂ£ûÂ§¢„ÄÇ', effect: { moneyMultiplier: 3, forceBadDream: true } }, 'risk': { name: 'È¢®Èö™Ëó•Âäë', description: '‰∏ãÊ¨°Â§¢Â¢ÉËã•ÊòØÂ•ΩÂ§¢ÔºåÁçéÂãµx3ÔºõËã•ÊòØÂ£ûÂ§¢ÔºåÊá≤ÁΩ∞‰πüx3„ÄÇ', effect: { moneyMultiplier: 3, isRisky: true } } };
    const goodDreams = [ { name: 'ÊòüÂÖâÊçïÊâã', startFunction: startStarCatcher }, { name: 'Ë®òÊÜ∂ÊòüËªå', startFunction: startMemoryTrail }, { name: 'Â§¢Â¢ÉÈá£È≠ö', startFunction: startDreamFishing }, { name: 'ÊÉÖÁ∑íÊï¥ÁêÜ', startFunction: startTidyEmotions }, { name: 'Â§¢Â¢ÉÁ∑®Áπî', startFunction: startDreamWeaving } ];
    const badDreams = [ { name: 'Â§¢È≠òÊéôËÑ´', startFunction: startNightmareEscape }, { name: 'Ëø∑ÂÆÆÂ≤îË∑Ø', startFunction: startMazeQTE }, { name: 'Ë∫≤ÈÅøÈô∞ÂΩ±', startFunction: startDodgeShadows }, { name: 'È¨ºÂ£ìÂ∫ä', startFunction: startSleepParalysis } ];
    const fortunes = [ { name: 'Â§ßÂêâ', color: '#ff4757', tagline: '‰ªäÂ§©Â∞áÊòØÁÑ°ËàáÂÄ´ÊØîÁöÑ‰∏ÄÂ§©ÔºÅ', effect: () => { const bonus = 50 + 10 * pillowLevel; money += bonus; return `Áç≤Âæó‰∫Ü ${bonus} üí∞ ÁöÑÊÑèÂ§ñ‰πãË≤°ÔºÅ`; } }, { name: '‰∏≠Âêâ', color: '#ffa502', tagline: 'Â•ΩÈÅãÊ≠£Âú®Âêë‰Ω†ÊãõÊâã„ÄÇ', effect: () => { tempGoodDreamChanceBonus = 10; return `‰∏ãÊ¨°ÂÖ•Áù°ÁöÑÂ•ΩÂ§¢Ê©üÁéáÊö´ÊôÇÊèêÂçá10%ÔºÅ`; } }, { name: 'Â∞èÂêâ', color: '#2ed573', tagline: 'ÂæÆÂ∞èÁöÑÂπ∏ÈÅãÔºå‰πüËÉΩÂ∏∂‰æÜÂø´Ê®Ç„ÄÇ', effect: () => { const bonus = 20 + 5 * pillowLevel; money += bonus; return `ÊíøÂà∞‰∫Ü ${bonus} üí∞ÔºÅ`; } }, { name: 'Âá∂', color: '#5352ed', tagline: 'ÁÉèÈõ≤Á±†ÁΩ©...Áúã‰æÜË¶ÅÂ∞èÂøÉË°å‰∫ã„ÄÇ', effect: () => { const loss = 15 * bedLevel; money = Math.max(0, money - loss); return `‰∏çÂ∞èÂøÉÈÅ∫Â§±‰∫Ü ${loss} üí∞...`; } }, { name: 'Â§ßÂá∂', color: '#1e272e', tagline: 'Ë´∏‰∫ã‰∏çÈ†ÜÔºåÁ†¥Ë≤°‰πãÁõ∏ÔºÅ', effect: () => { money = Math.floor(money * 0.8); return `ÈÅ≠ÈÅáËøéÈ†≠ÁóõÊìäÔºåÊêçÂ§±‰∫Ü20%ÁöÑË≤°Áî¢ÔºÅ`; } } ];
    const randomMainEvents = [ { name: 'Meteor Shower', start: startMeteorShower }, { name: 'Dream Merchant', start: startDreamMerchant } ];
    const merchantPotions = [ { id: 'power', cost: 100 }, { id: 'peace', cost: 120 }, { id: 'greed', cost: 200 }, { id: 'risk', cost: 80 } ];
    const storyData = { 1: { title: "Á¨¨‰∏ÄÂ§ú", text: "ÈÄôÊòØ‰∏ÄÂÄãÂ•áÊÄ™ÁöÑÂ§¢...ÊÑüË¶∫Êó¢ÁÜüÊÇâÂèàÈôåÁîü„ÄÇ" }, 5: { title: "Á¨¨‰∫îÂ§ú", text: "ÂÅ∂ÁàæÔºå‰Ω†ÊúÉÂú®Â£ûÂ§¢ÁöÑÈÇäÁ∑£Áû•Ë¶ã‰∏Ä‰∫õÈô∞ÂΩ±ÔºåÂÆÉÂÄë‰ºº‰πéÂú®‰ΩéË™û„ÄÇ" }, 10: { title: "Á¨¨ÂçÅÂ§úÁöÑË®òÊÜ∂", text: "‰Ω†ÊÑüË¶∫Â∫äÈã™ÊüîËªüÂæó‰∏çÂèØÊÄùË≠∞„ÄÇÂ§¢‰∏≠ÁöÑÈáëÈå¢‰ºº‰πé‰πüËÆäÂæóÊõ¥„ÄéÁúüÂØ¶„Äè‰∫Ü„ÄÇ‰∏ÄÁµ≤Ê®°Á≥äÁöÑË®òÊÜ∂ÈñÉÈÅéÔºö‰∏ÄÈñìÊòé‰∫ÆÁöÑÊàøÈñìÔºåÁ™óÂ§ñÊòØÁ∂†Ëâ≤ÁöÑ...ÊòØ‰ªÄÈ∫ºÔºü" }, 15: { title: "Á¨¨ÂçÅ‰∫îÂ§ú", text: "‰Ω†ÈñãÂßãÁøíÊÖ£Âú®Â§¢‰∏≠ÈÜí‰æÜÔºåÂçáÁ¥öÔºåÁÑ∂ÂæåÂÜçÊ¨°ÂÖ•Áù°„ÄÇÈÄôÂΩ∑ÂΩøÊàê‰∫Ü‰∏ÄÁ®ÆÂÑÄÂºè„ÄÇ" }, 20: { title: "Á¨¨‰∫åÂçÅÂ§úÁöÑ‰ΩéË™û", text: "‰Ω†Âú®Â£ûÂ§¢‰∏≠ËÅΩË¶ã‰∫ÜÊõ¥Ê∏ÖÊô∞ÁöÑËÄ≥Ë™ûÔºö„Äé...ÈÇÑ‰∏çÂ§†...„Äè„ÄÇÊòØË™∞Âú®Ë™™Ë©±Ôºü" }, 25: { title: "Á¨¨‰∫åÂçÅ‰∫îÂ§ú", text: "Â§¢Â¢ÉÂïÜ‰∫∫ÊòØÂÄãÂ•áÊÄ™ÁöÑÂÇ¢‰ºô„ÄÇ‰ªñÁöÑËó•Ê∞¥ÊïàÊûúÂº∑Â§ßÔºå‰ΩÜÁ∏ΩÊÑüË¶∫‰ªñÂ∞ç‰Ω†ÁöÑËôïÂ¢ÉÁû≠Ëã•ÊåáÊéå„ÄÇ" }, 30: { title: "Á¨¨‰∏âÂçÅÂ§úÁöÑÊ∞£Âë≥", text: "Â§¢Â¢ÉÁöÑËâ≤ÂΩ©ÊØîÂπ≥ÊôÇÊõ¥ÈÆÆË±î‰∫Ü„ÄÇ‰Ω†Á¨¨‰∏ÄÊ¨°Âú®Â§¢Ë£°ÔºåËÅûÂà∞‰∫ÜÂØßÁ•ûËñ∞È¶ôÁöÑÂë≥ÈÅì...ÈÄôÂë≥ÈÅìËÆì‰Ω†Âπæ‰πéÊÉ≥Ëµ∑‰∫ÜÊüêÂÄãÊ∫´ÊöñÁöÑÂçàÂæå„ÄÇ" }, 38: { title: "Á¨¨‰∏âÂçÅÂÖ´Â§ú", text: "ÊúâÈÇ£È∫º‰∏ÄÁû¨ÈñìÔºå‰Ω†ÁúãËëóÊûïÈ†≠ÔºåË¶∫ÂæóÂÆÉÊáâË©≤ÊòØÂè¶‰∏ÄÁ®ÆÈ°èËâ≤„ÄÇ‰ΩÜ‰Ω†ÂæàÂø´Â∞±Âøò‰∫ÜÈÇ£ÊòØ‰ªÄÈ∫ºÈ°èËâ≤„ÄÇ" }, 40: { title: "Á¨¨ÂõõÂçÅÂ§úÁöÑÁû•Ë¶ã", text: "‰Ω†Áû•Ë¶ã‰∏ÄÂÄãÁ•ûÁßòÁöÑÂΩ±Â≠êÔºåÂÆÉ‰ºº‰πéÂ∞±ÊòØÈÇ£‰ΩçÂÅ∂ÁàæÂá∫ÁèæÁöÑÂïÜ‰∫∫„ÄÇ‰ªñÂ∞ç‰Ω†Èªû‰∫ÜÈªûÈ†≠Ôºå‰æøÊ∂àÂ§±Âú®Ëø∑Èúß‰∏≠„ÄÇ‰ªñ‰∏çÊòØÊïµ‰∫∫ÂóéÔºü" }, 46: { title: "Á¨¨ÂõõÂçÅÂÖ≠Â§ú", text: "ÊµÅÊòüÈõ®ÂäÉÈÅéÂ§©ÈöõÊôÇÔºå‰Ω†Ë®±‰∫Ü‰∏ÄÂÄãÈ°òÔºö„ÄéÊàëÊÉ≥ÂõûÂÆ∂„Äè„ÄÇ‰ΩÜ‰Ω†ÁîöËá≥‰∏çÁ¢∫ÂÆöÂÆ∂Âú®Âì™Ë£°„ÄÇ" }, 50: { title: "Á¨¨‰∫îÂçÅÂ§úÁöÑÁ¢éÁâá", text: "ÂçäÂ§¢ÂçäÈÜí‰πãÈñìÔºå‰Ω†Êäì‰Ωè‰∫Ü‰∏Ä‰∫õË®òÊÜ∂Á¢éÁâáÔºöÁ¨ëËÅ≤„ÄÅÈôΩÂÖâ„ÄÅÈÇÑÊúâ‰∏ÄÂÄãÊ®°Á≥äÁöÑ‰∫∫ÂΩ±„ÄÇ‰ΩÜÂÆÉÂÄëÂÉèÊåáÈñìÁöÑÊ≤ô‰∏ÄÊ®£Ê∫úËµ∞„ÄÇÂøÉË£°‰∏ÄÈô£Âà∫Áóõ„ÄÇ" }, 58: { title: "Á¨¨‰∫îÂçÅÂÖ´Â§ú", text: "ÊçïÂ§¢Á∂≤‰∏çÂÉÖËÉΩÊìã‰ΩèÈáëÈå¢ÁöÑÊµÅÂ§±Ôºå‰ºº‰πé‰πüËÉΩÈÅéÊøæÊéâ‰∏Ä‰∫õÊúÄÊ∑±Ê≤âÁöÑÊÅêÊáº„ÄÇ" }, 60: { title: "Á¨¨ÂÖ≠ÂçÅÂ§úÁöÑÊ∑öÁè†", text: "‰Ω†ÁôºÁèæÊçïÂ§¢Á∂≤‰∏äÊéõËëó‰∏ÄÈ°ÜÂ∞èÂ∞èÁöÑ„ÄÅÈñÉÂÖâÁöÑÈú≤Áè†„ÄÇ‰Ω†Ëß∏Á¢∞ÂÆÉÔºå‰∏ÄËÇ°ÊÇ≤ÂÇ∑ÁöÑÊÉÖÁ∑íÊπß‰∏äÂøÉÈ†≠„ÄÇÈÄô‰∏çÊòØ‰Ω†ÁöÑ...Â∞çÂêßÔºü" }, 67: { title: "Á¨¨ÂÖ≠ÂçÅ‰∏ÉÂ§ú", text: "‰Ω†ÈñãÂßã‰∫´ÂèóÊÉÖÁ∑íÊï¥ÁêÜÁöÑÈÅéÁ®ãÔºåÂ∞áÊ∑∑‰∫ÇÁöÑÊÑüË¶∫‰∏Ä‰∏ÄÊ≠∏‰ΩçÔºå‰ºº‰πé‰πüÂú®Êï¥ÁêÜËá™Â∑±Ê∑∑‰∫ÇÁöÑË®òÊÜ∂„ÄÇ" }, 70: { title: "Á¨¨‰∏ÉÂçÅÂ§úÁöÑÈÅºÈóä", text: "Â§¢‰∏≠ÁöÑ‰∏ñÁïåËÆäÂæóÂª£ÈóäÁÑ°ÈÇäÔºå‰Ω†ÊÑüË¶∫Ëá™Â∑±ÂΩ∑ÂΩøËÉΩËµ∞Âà∞‰ªª‰ΩïÂú∞Êñπ...Âè™Ë¶Å‰Ω†ÈÇÑÊÉ≥ÁπºÁ∫åÂÅöÂ§¢„ÄÇ‰ΩÜ...‰Ω†ÁúüÁöÑÊÉ≥ÂóéÔºü" }, 75: { title: "Á¨¨‰∏ÉÂçÅ‰∫îÂ§ú", text: "‰Ω†ÈñãÂßãÊá∑ÁñëÔºåÈÄô‰∫õÂ•ΩÂ§¢ÂíåÂ£ûÂ§¢Ôºå‰πüË®±ÈÉΩÊ∫êÊñº‰Ω†Ëá™Â∑±„ÄÇ" }, 80: { title: "Á¨¨ÂÖ´ÂçÅÂ§úÁöÑÂÖâËäí", text: "‰Ω†Â∞çÂ§¢Â¢ÉÁöÑÊéåÊéßÂäõË∂ä‰æÜË∂äÂº∑„ÄÇÂú®‰∏ÄÊ¨°Â£ûÂ§¢‰∏≠Ôºå‰Ω†ÊÜëËóâËá™Â∑±ÁöÑÊÑèÂøóÈªû‰∫Æ‰∫Ü‰∏ÄÁõûÁáàÔºåÈô∞ÂΩ±Áü≠Êö´Âú∞ÈÄÄÂéª‰∫Ü„ÄÇ‰Ω†Á¨¨‰∏ÄÊ¨°ÊÑüË¶∫Âà∞ÂäõÈáè„ÄÇ" }, 88: { title: "Á¨¨ÂÖ´ÂçÅÂÖ´Â§ú", text: "„ÄéÈÜí‰æÜ„ÄèÈÄôÂÄãË©ûÔºåÁèæÂú®ËÅΩËµ∑‰æÜÊó¢ÂÖÖÊªøÂ∏åÊúõÔºåÂèàËÆì‰∫∫ÁïèÊáº„ÄÇ" }, 90: { title: "Á¨¨‰πùÂçÅÂ§úÁöÑÂπ≥Èùú", text: "‰∏ÄÁ®ÆÂ•áÁâπÁöÑÂπ≥ÈùúÊÑüÁ±†ÁΩ©Ëëó‰Ω†„ÄÇ‰Ω†‰∏çÂÜçÂÆ≥ÊÄïÂ£ûÂ§¢Ôºå‰πü‰∏çÂÜçË≤™ÊàÄÂ•ΩÂ§¢„ÄÇ‰Ω†Â•ΩÂÉè...Ê∫ñÂÇôÂ•Ω‰∫Ü„ÄÇ" }, 95: { title: "Á¨¨‰πùÂçÅ‰∫îÂ§ú", text: "‰Ω†ÊúÄÂæå‰∏ÄÊ¨°ÂçáÁ¥ö‰∫Ü‰Ω†ÁöÑÂ∫ä„ÄÇÂÆÉÁÑ°ÊØîËàíÈÅ©Ôºå‰ΩÜ‰Ω†Áü•ÈÅì‰Ω†‰∏çÊúÉÂÜçÈúÄË¶ÅÂÆÉ‰∫Ü„ÄÇ" }, 99: { title: "Á¨¨‰πùÂçÅ‰πùÂ§ú", text: "ÊúÄÂæå‰∏ÄÂ§ú„ÄÇ‰Ω†Âπ≥ÈùúÂú∞Ë∫∫‰∏ãÔºå‰Ω†Áü•ÈÅìÔºåÈÄôÊ¨°ÂÖ•Áù°Â∞áÊúÉÊòØÊúÄÂæå‰∏ÄÊ¨°„ÄÇ" } };
    const endingContent = "Á¨¨‰∏ÄÁôæÂ§úÔºå‰Ω†ÁùúÈñã‰∫ÜÈõôÁúº„ÄÇÊ≤íÊúâÂ•ΩÂ§¢Ôºå‰πüÊ≤íÊúâÂ£ûÂ§¢„ÄÇÂë®ÈÅ≠‰∏ÄÁâáËôõÁÑ°ÔºåÂè™Êúâ‰∏ÄÊâáÊï£ÁôºËëóÂæÆÂÖâ„ÄÅÁî±‰Ω†ÊâÄÊúâÂ§¢Â¢ÉÁ¢éÁâáÊßãÊàêÁöÑÈñÄÊââ„ÄÇ‰Ω†Âπ≥ÈùúÂú∞Ëµ∞‰∏äÂâçÔºåËºïËºïÊé®Èñã„ÄÇÈñÄÂæåÊòØÊ∫´ÊöñÁöÑÊô®ÂÖâÔºå‰ª•Âèä‰∏ÄÂÄã‰Ω†Âπæ‰πéÈÅ∫ÂøòÁöÑ„ÄÅÂ∂ÑÊñ∞ÁöÑÈñãÂßã„ÄÇ";
    
    // --- 2. ÂÖÉÁ¥†ËÆäÊï∏ÂÆ£Âëä ---
    let gameContainer, dayCountEl, moneyEl, goodDreamChanceEl, gameLogEl, sleepButton, bedLevelEl, pillowLevelEl, dreamCatcherLevelEl, incenseLevelEl, bedUpgradeCostEl, pillowUpgradeCostEl, dreamCatcherUpgradeCostEl, incenseUpgradeCostEl, upgradeBedButton, upgradePillowButton, upgradeDreamCatcherButton, upgradeIncenseButton, minigameModal, minigameTitle, minigameInstruction, minigameInfoBar, minigameArea, minigameResultEl, eventModal, eventResultEl, cardContainer, goodDreamItemCostEl, badDreamItemCostEl, buyGoodDreamItemButton, buyBadDreamItemButton, merchantModal, merchantTimerEl, merchantItemsEl, potionEffectStatusEl, settingsButton, settingsModal, deleteSaveButton, settingsCloseButton, storyModal, storyModalTitle, storyModalText, storyModalCloseButton, endingModal, endingText, endingResetButton, endingContinueButton, backpackButton, backpackModal, backpackItemsEl, backpackCloseButton, mobileControlsContainer;

    // --- 3. Ê†∏ÂøÉÂäüËÉΩÂáΩÂºè ---
    function logMessage(message, isLoad = false) { const p = document.createElement('p'); p.innerHTML = message; gameLogEl.appendChild(p); gameLogEl.scrollTop = gameLogEl.scrollHeight; if (!isLoad) { gameLogHTML = gameLogEl.innerHTML; saveGame(); } }
    
    function updateStatsUI() { 
        if(!dayCountEl) return;
        dayCountEl.textContent = dayCount;
        moneyEl.textContent = money; 
        goodDreamChanceEl.innerHTML = `${baseGoodDreamChance}% ${tempGoodDreamChanceBonus > 0 ? `<span style="color:var(--good-color)">(+${tempGoodDreamChanceBonus}%)</span>` : ''}`;

        bedLevelEl.textContent = bedLevel; pillowLevelEl.textContent = pillowLevel; dreamCatcherLevelEl.textContent = dreamCatcherLevel; incenseLevelEl.textContent = incenseLevel;
        bedUpgradeCostEl.textContent = bedUpgradeCost; pillowUpgradeCostEl.textContent = pillowUpgradeCost; dreamCatcherUpgradeCostEl.textContent = dreamCatcherUpgradeCost; incenseUpgradeCostEl.textContent = incenseUpgradeCost;
        
        const buttonsDisabled = minigameActive || eventActive || mainScreenEventActive || storyModalActive || endingActive || settingsModalActive || backpackModalActive;
        
        sleepButton.disabled = buttonsDisabled; 
        backpackButton.disabled = buttonsDisabled;
        upgradeBedButton.disabled = money < bedUpgradeCost || buttonsDisabled || baseGoodDreamChance >= 95;
        upgradePillowButton.disabled = money < pillowUpgradeCost || buttonsDisabled;
        upgradeDreamCatcherButton.disabled = money < dreamCatcherUpgradeCost || buttonsDisabled;
        upgradeIncenseButton.disabled = money < incenseUpgradeCost || buttonsDisabled;
        buyGoodDreamItemButton.disabled = money < goodDreamItemCost || buttonsDisabled;
        buyBadDreamItemButton.disabled = money < badDreamItemCost || buttonsDisabled;
        
        let effectText = "";
        if (effectNextGoodDream) effectText = "ÊïàÊûú: ‰∏ãÊ¨°ÂøÖÂÆöÂ•ΩÂ§¢";
        else if (effectNextBadDream) effectText = "ÊïàÊûú: ‰∏ãÊ¨°ÂøÖÂÆöÂ£ûÂ§¢";
        else if (activePotion) effectText = `Ëó•Ê∞¥ÊïàÊûú: ${itemsData[activePotion.id].name}`;
        potionEffectStatusEl.textContent = effectText;
    }
    
    function goToSleep() {
        if (dayCount === 0 && storyData[1]) { logMessage(`<i>${storyData[1].text}</i>`); }
        dayCount++;
        logMessage(`--- Á¨¨ ${dayCount} Â§© ---`);
        
        let isGoodDream;
        if (effectNextGoodDream) { isGoodDream = true; effectNextGoodDream = false; logMessage("üçÄ ‰Ω†‰ΩøÁî®‰∫ÜÂπ∏ÈÅãÂõõËëâËçâ..."); } 
        else if (effectNextBadDream) { isGoodDream = false; effectNextBadDream = false; logMessage("üéé ‰Ω†‰ΩøÁî®‰∫ÜË©õÂííÂ®ÉÂ®É..."); } 
        else if (activePotion && itemsData[activePotion.id].effect.forceBadDream) { isGoodDream = false; logMessage(`üß™ ${itemsData[activePotion.id].name} ÁöÑÊïàÊûúÁôº‰Ωú‰∫Ü...`); } 
        else { 
            let finalChance = baseGoodDreamChance + tempGoodDreamChanceBonus;
            finalChance *= (activePotion ? (itemsData[activePotion.id].effect.goodChanceMultiplier || 1) : 1);
            isGoodDream = Math.random() * 100 < finalChance; 
        }
        tempGoodDreamChanceBonus = 0;
        
        minigameActive = true; 
        saveGameAndUpdateUI();
        logMessage("‰Ω†Á∑©Á∑©Èñâ‰∏äÁúºÁùõÔºåÈÄ≤ÂÖ•‰∫ÜÂ§¢ÈÑâ..."); 

        setTimeout(() => { 
            const dreamPool = isGoodDream ? goodDreams : badDreams; 
            const selectedDream = dreamPool[Math.floor(Math.random() * dreamPool.length)]; 
            selectedDream.startFunction(); 
        }, 1500); 
    }

    function checkPostSleepEvents() {
        hideMinigame();
        if (dayCount >= 100) { setTimeout(showEnding, 500); } 
        else if (storyData[dayCount]) { setTimeout(() => showStory(dayCount), 500); }
    }
    
    function showEndScreen(resultText, logText, success) { 
        if (!minigameActive) return;
        if (activePotion && itemsData[activePotion.id].effect.forceSuccess) { success = true; resultText += " (Ëó•Ê∞¥ÊïàÊûú)"; }
        
        minigameActive = false; 
        clearTimersAndListeners(); 
        minigameArea.style.pointerEvents = 'none'; 
        minigameResultEl.textContent = resultText; 
        minigameResultEl.style.color = success === false ? 'var(--bad-color)' : success === true ? 'var(--good-color)' : 'var(--neutral-color)'; 
        if (logText) logMessage(logText); 
        
        if(activePotion) { logMessage(`üß™ ${itemsData[activePotion.id].name} ÁöÑÊïàÊûúÊ∂àÂ§±‰∫Ü„ÄÇ`); activePotion = null; }
        
        saveGame();
        
        const EVENT_CHANCE = 0.3; 
        if (Math.random() < EVENT_CHANCE && dayCount < 100) { setTimeout(() => startFortuneEvent(), 2000); } 
        else { setTimeout(checkPostSleepEvents, 3000); } 
    }
    
    function hideMinigame() { 
        gameContainer.classList.remove('frozen'); 
        minigameModal.classList.add('hidden'); 
        if (!eventActive && !storyModalActive && !endingActive) { minigameActive = false; saveGameAndUpdateUI(); } 
    }
    
    function flipCard(clickedCard, chosenFortune) { 
        document.querySelectorAll('.card').forEach(c => c.onclick = null); clickedCard.classList.add('is-flipped'); const effectMessage = chosenFortune.effect(); logMessage(`„ÄêÈÅãÂã¢Ôºö${chosenFortune.name}„Äë${chosenFortune.tagline} ${effectMessage}`); eventResultEl.textContent = effectMessage; saveGameAndUpdateUI();
        setTimeout(() => { document.querySelectorAll('.card:not(.is-flipped)').forEach(otherCard => { otherCard.classList.add('is-flipped'); }); }, 1000); 
        setTimeout(() => { eventModal.classList.add('hidden'); eventActive = false; checkPostSleepEvents(); }, 4000); 
    }

    function calculateEarnings(baseAmount, isLoss = false) {
        let multiplier = 1;
        if (activePotion) {
            if (itemsData[activePotion.id].effect.isRisky) { multiplier = 3; } 
            else if (!isLoss) { multiplier = itemsData[activePotion.id].effect.moneyMultiplier || 1; }
        }
        let finalAmount = baseAmount * multiplier;
        if (isLoss) { const lossReduction = 1 - (dreamCatcherLevel - 1) * 0.1; finalAmount *= lossReduction; }
        return Math.round(finalAmount);
    }
    
    function upgradeBed() { if (money >= bedUpgradeCost) { money -= bedUpgradeCost; bedLevel++; baseGoodDreamChance = Math.min(95, baseGoodDreamChance + 5); bedUpgradeCost = Math.floor(bedUpgradeCost * 1.6); logMessage(`üõ†Ô∏è Â∫äÂçáÁ¥ö‰∫ÜÔºÅÁ≠âÁ¥ö ${bedLevel}ÔºåÂü∫Á§éÂ•ΩÂ§¢Ê©üÁéáÊèêÂçáËá≥ ${baseGoodDreamChance}%„ÄÇ`); saveGameAndUpdateUI(); } }
    function upgradePillow() { if (money >= pillowUpgradeCost) { money -= pillowUpgradeCost; pillowLevel++; pillowUpgradeCost = Math.floor(pillowUpgradeCost * 1.7); logMessage(`üõ†Ô∏è ÊûïÈ†≠ÂçáÁ¥ö‰∫ÜÔºÅÁ≠âÁ¥ö ${pillowLevel}ÔºåÈáëÈå¢Áç≤ÂèñÈáèÊèêÂçá„ÄÇ`); saveGameAndUpdateUI(); } }
    function upgradeDreamCatcher() { if (money >= dreamCatcherUpgradeCost) { money -= dreamCatcherUpgradeCost; dreamCatcherLevel++; dreamCatcherUpgradeCost = Math.floor(dreamCatcherUpgradeCost * 1.8); logMessage(`üõ†Ô∏è ÊçïÂ§¢Á∂≤ÂçáÁ¥ö‰∫ÜÔºÅÁ≠âÁ¥ö ${dreamCatcherLevel}ÔºåËÉΩÊäµÁ¶¶Êõ¥Â§öÂ£ûÂ§¢ÊêçÂ§±„ÄÇ`); saveGameAndUpdateUI(); } }
    function upgradeIncense() { if (money >= incenseUpgradeCost) { money -= incenseUpgradeCost; incenseLevel++; incenseUpgradeCost = Math.floor(incenseUpgradeCost * 1.75); logMessage(`üõ†Ô∏è ÂØßÁ•ûËñ∞È¶ôÂçáÁ¥ö‰∫ÜÔºÅÁ≠âÁ¥ö ${incenseLevel}ÔºåÂ§¢Â¢ÉËÆäÂæóÊõ¥ÂÆâÁ©©„ÄÇ`); saveGameAndUpdateUI(); } }
    function startFortuneEvent() { eventActive = true; updateStatsUI(); eventModal.classList.remove('hidden'); cardContainer.innerHTML = ''; eventResultEl.textContent = ''; const shuffledFortunes = [...fortunes].sort(() => 0.5 - Math.random()); const selectedFortunes = shuffledFortunes.slice(0, 3); selectedFortunes.forEach(fortune => { const card = document.createElement('div'); card.className = 'card'; const cardInner = document.createElement('div'); cardInner.className = 'card-inner'; const cardBack = document.createElement('div'); cardBack.className = 'card-face card-back'; cardBack.textContent = '‚ùì'; const cardFront = document.createElement('div'); cardFront.className = 'card-face card-front'; cardFront.innerHTML = `<div class="fortune-name" style="color:${fortune.color};">${fortune.name}</div><div class="fortune-tagline">${fortune.tagline}</div>`; cardInner.appendChild(cardBack); cardInner.appendChild(cardFront); card.appendChild(cardInner); card.onclick = () => flipCard(card, fortune); cardContainer.appendChild(card); }); }
    
    // --- 4. Â≠òÊ™î/ÂïÜÂ∫ó/ËÉåÂåÖ/ÂäáÊÉÖÁ≥ªÁµ± ---
    function saveGame() {
        const gameState = { dayCount, money, baseGoodDreamChance, bedLevel, pillowLevel, dreamCatcherLevel, incenseLevel, bedUpgradeCost, pillowUpgradeCost, dreamCatcherUpgradeCost, incenseUpgradeCost, inventory, gameLogHTML, effectNextGoodDream, effectNextBadDream, activePotion };
        localStorage.setItem('dreamGameSaveData', JSON.stringify(gameState));
    }

    function loadGame() {
        const savedData = localStorage.getItem('dreamGameSaveData');
        if (savedData) {
            const gameState = JSON.parse(savedData);
            dayCount = gameState.dayCount || 0; money = gameState.money || 0; baseGoodDreamChance = gameState.baseGoodDreamChance || 50; bedLevel = gameState.bedLevel || 1; pillowLevel = gameState.pillowLevel || 1; dreamCatcherLevel = gameState.dreamCatcherLevel || 1; incenseLevel = gameState.incenseLevel || 1; bedUpgradeCost = gameState.bedUpgradeCost || 50; pillowUpgradeCost = gameState.pillowUpgradeCost || 70; dreamCatcherUpgradeCost = gameState.dreamCatcherUpgradeCost || 100; incenseUpgradeCost = gameState.incenseUpgradeCost || 120; inventory = gameState.inventory || {}; gameLogHTML = gameState.gameLogHTML || "Ê≠°Ëøé‰æÜÂà∞Â§¢Â¢ÉÈÅäÊà≤ÔºÅ‰ªäÊôöÊúÉÊòØ‰ªÄÈ∫ºÂ§¢Âë¢Ôºü"; effectNextGoodDream = gameState.effectNextGoodDream || false; effectNextBadDream = gameState.effectNextBadDream || false; activePotion = gameState.activePotion || null;
            logMessage("üíæ ËÆÄÂèñÂ≠òÊ™îÊàêÂäüÔºÅÊ≠°ËøéÂõû‰æÜ„ÄÇ", true);
        } else {
            dayCount = 0; money = 0; baseGoodDreamChance = 50; bedLevel = 1; pillowLevel = 1; dreamCatcherLevel = 1; incenseLevel = 1; bedUpgradeCost = 50; pillowUpgradeCost = 70; dreamCatcherUpgradeCost = 100; incenseUpgradeCost = 120; inventory = {}; gameLogHTML = ""; effectNextGoodDream = false; effectNextBadDream = false; activePotion = null;
            logMessage("Ê≠°Ëøé‰æÜÂà∞Â§¢Â¢ÉÈÅäÊà≤ÔºÅ‰ªäÊôöÊúÉÊòØ‰ªÄÈ∫ºÂ§¢Âë¢Ôºü", true);
        }
        tempGoodDreamChanceBonus = 0;
        gameLogEl.innerHTML = gameLogHTML;
        gameLogEl.scrollTop = gameLogEl.scrollHeight;
    }
    
    function saveGameAndUpdateUI() { saveGame(); updateStatsUI(); }
    function deleteSaveAndReset() { deleteSaveButton.disabled = true; if (confirm("Ë≠¶ÂëäÔºöÊ≠§Âãï‰ΩúÂ∞áÊúÉÊ∞∏‰πÖÂà™Èô§ÊÇ®ÊâÄÊúâÁöÑÈÅäÊà≤ÈÄ≤Â∫¶ÔºåÁ¢∫ÂÆöË¶ÅÈáçÁΩÆÂóéÔºü")) { localStorage.removeItem('dreamGameSaveData'); location.reload(); } else { deleteSaveButton.disabled = false; } }
    function showStory(day) { storyModalActive = true; gameContainer.classList.add('frozen'); const story = storyData[day]; storyModalTitle.textContent = story.title; storyModalText.textContent = story.text; storyModal.classList.remove('hidden'); logMessage(`<strong>--- ${story.title} ---</strong><br><i>${story.text}</i>`); updateStatsUI(); }
    function showEnding() { endingActive = true; gameContainer.classList.add('frozen'); endingModal.classList.remove('hidden'); logMessage(`<strong>--- Á¨¨‰∏ÄÁØáÁ´†„ÉªÂÆå ---</strong>`); updateStatsUI(); }

    function buyItem(itemId, cost) {
        if (money >= cost) {
            money -= cost;
            inventory[itemId] = (inventory[itemId] || 0) + 1;
            logMessage(`üõçÔ∏è ‰Ω†Ë≥ºË≤∑‰∫Ü ${itemsData[itemId].name}ÔºÅ`);
            saveGameAndUpdateUI();
        }
    }

    function openBackpack() { backpackModalActive = true; renderBackpack(); backpackModal.classList.remove('hidden'); updateStatsUI(); }
    function closeBackpack() { backpackModalActive = false; backpackModal.classList.add('hidden'); updateStatsUI(); }
    function renderBackpack() {
        backpackItemsEl.innerHTML = '';
        if (Object.keys(inventory).every(k => !inventory[k])) { backpackItemsEl.innerHTML = '<p>‰Ω†ÁöÑËÉåÂåÖÁ©∫ÁÑ°‰∏ÄÁâ©„ÄÇ</p>'; return; }
        for(const itemId in inventory) {
            if (inventory[itemId] > 0) {
                const item = itemsData[itemId];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'upgrade-item';
                itemDiv.innerHTML = `<div><p><strong>${item.name}</strong> (ÊåÅÊúâ: ${inventory[itemId]})</p><p>${item.description}</p></div><button data-item-id="${itemId}">‰ΩøÁî®</button>`;
                backpackItemsEl.appendChild(itemDiv);
            }
        }
    }
    function useItem(itemId) {
        const hasActiveEffect = effectNextGoodDream || effectNextBadDream || activePotion;
        if (hasActiveEffect) { logMessage("‚ùå ‰Ω†Â∑≤Á∂ìÊúâ‰∏ÄÂÄãÁîüÊïà‰∏≠ÁöÑÁâ©ÂìÅ‰∫ÜÔºÅ"); return; }
        inventory[itemId]--;
        if (inventory[itemId] <= 0) delete inventory[itemId];
        switch(itemId) {
            case 'luckyClover': effectNextGoodDream = true; break;
            case 'cursedDoll': effectNextBadDream = true; break;
            default: const potionData = merchantPotions.find(p => p.id === itemId); if(potionData) activePotion = potionData; break;
        }
        logMessage(`‰Ω†‰ΩøÁî®‰∫Ü ${itemsData[itemId].name}ÔºÅ`);
        closeBackpack();
        saveGameAndUpdateUI();
    }
    
    // --- 5. ‰∫ã‰ª∂ËàáÂ∞èÈÅäÊà≤ÈÇèËºØ ---
    function triggerRandomEvent() { if (minigameActive || eventActive || mainScreenEventActive || storyModalActive || endingActive || backpackModalActive) return; const CHANCE = 0.25; if (Math.random() < CHANCE) { const selectedEvent = randomMainEvents[Math.floor(Math.random() * randomMainEvents.length)]; selectedEvent.start(); } }
    function startMeteorShower() { mainScreenEventActive = true; document.body.style.overflow = 'hidden'; saveGameAndUpdateUI(); logMessage("üå† Â§©Á©∫ÈñãÂßãÈôç‰∏ãÊµÅÊòüÈõ®ÔºÅÂø´ÈªûÊìäÂÆÉÂÄëÔºÅ"); let meteorsCaught = 0; const duration = 10000; const spawner = setInterval(() => { const meteor = document.createElement('div'); meteor.textContent = '‚òÑÔ∏è'; meteor.className = 'meteor'; meteor.style.left = `${Math.random() * 100}vw`; meteor.style.top = `-50px`; meteor.style.animation = `fall-meteor ${2 + Math.random() * 2}s linear`; meteor.onclick = () => { meteorsCaught++; const reward = Math.ceil(1 + pillowLevel * 0.5); money += reward; updateStatsUI(); meteor.classList.add('popped'); meteor.onclick = null; setTimeout(() => meteor.remove(), 300); }; document.body.appendChild(meteor); setTimeout(() => { if(meteor) meteor.remove() }, 4000); }, 300); setTimeout(() => { clearInterval(spawner); mainScreenEventActive = false; document.body.style.overflow = 'auto'; logMessage(`üå† ÊµÅÊòüÈõ®ÁµêÊùü‰∫ÜÔºå‰Ω†ÊäìÂà∞‰∫Ü ${meteorsCaught} È°ÜÊµÅÊòüÔºÅ`); saveGameAndUpdateUI(); }, duration); }
    function startDreamMerchant() { mainScreenEventActive = true; saveGameAndUpdateUI(); merchantModal.classList.remove('hidden'); logMessage("üé≠ ‰∏Ä‰ΩçÁ•ûÁßòÁöÑÂïÜ‰∫∫Âá∫ÁèæÂú®‰Ω†ÁöÑÂ§¢Â¢ÉÈÇäÁ∑£..."); let timeLeft = 20; merchantTimerEl.textContent = timeLeft; merchantItemsEl.innerHTML = ''; const shuffledPotions = [...merchantPotions].sort(() => 0.5 - Math.random()); const itemsForSale = shuffledPotions.slice(0, 2); itemsForSale.forEach(potion => { const item = itemsData[potion.id]; const itemDiv = document.createElement('div'); itemDiv.className = 'upgrade-item'; itemDiv.innerHTML = `<div><p><strong>${item.name}</strong></p><p>${item.description}</p><p>ÂÉπÊ†º: ${potion.cost} üí∞</p></div><button data-item-id="${potion.id}" data-cost="${potion.cost}">Ë≥ºË≤∑</button>`; merchantItemsEl.appendChild(itemDiv); }); const buttons = merchantItemsEl.querySelectorAll('button'); buttons.forEach(b => { b.disabled = money < b.dataset.cost; b.onclick = (e) => { const itemId = e.target.dataset.itemId; const cost = parseInt(e.target.dataset.cost); buyItem(itemId, cost); buttons.forEach(btn => btn.disabled = money < btn.dataset.cost); }; }); const timer = setInterval(() => { timeLeft--; merchantTimerEl.textContent = timeLeft; if (timeLeft <= 0) { closeMerchant(timer); } }, 1000); const closeMerchant = (timerToClear = timer) => { clearInterval(timerToClear); merchantModal.classList.add('hidden'); mainScreenEventActive = false; logMessage("ÂïÜ‰∫∫Á•ûÁßòÂú∞Ê∂àÂ§±‰∫Ü..."); saveGameAndUpdateUI(); } }
    function clearTimersAndListeners() {
        clearInterval(gameInterval); clearTimeout(gameTimeout);
        if (keydownHandler) document.removeEventListener('keydown', keydownHandler);
        if (keyupHandler) document.removeEventListener('keyup', keyupHandler);
        if (mousemoveHandler) minigameArea.removeEventListener('mousemove', mousemoveHandler);
        if (touchMoveHandler) minigameArea.removeEventListener('touchmove', touchMoveHandler);
        const holdButton = document.getElementById('mobile-hold-button');
        if (holdButton && touchStartHandler) holdButton.removeEventListener('touchstart', touchStartHandler);
        if (holdButton && touchEndHandler) holdButton.removeEventListener('touchend', touchEndHandler);
        keydownHandler = keyupHandler = mousemoveHandler = touchMoveHandler = touchStartHandler = touchEndHandler = gameInterval = gameTimeout = null;
    }
    function showMinigame() { gameContainer.classList.add('frozen'); minigameModal.classList.remove('hidden'); minigameResultEl.innerHTML = ''; minigameInfoBar.innerHTML = ''; minigameArea.innerHTML = ''; minigameInstruction.textContent = ''; mobileControlsContainer.innerHTML = ''; mobileControlsContainer.classList.remove('visible'); minigameArea.style.pointerEvents = 'auto'; }
    function startStarCatcher() { let score = 0; let duration = 7 + (incenseLevel - 1); showMinigame(); minigameTitle.textContent = "‚ú® ÊòüÂÖâÊçïÊâã ‚ú®"; minigameInstruction.textContent = "Âú®ÊôÇÈñìÂÖßÁõ°ÂèØËÉΩÈªûÊìäÂá∫ÁèæÁöÑÊòüÊòüÔºÅ"; minigameInfoBar.innerHTML = `<span>ÊôÇÈñì: <span id="timer">${duration}</span>s</span> <span>ÂàÜÊï∏: <span id="score">0</span></span>`; const timerEl = document.getElementById('timer'); const scoreEl = document.getElementById('score'); const starSpawner = setInterval(() => { if (!minigameActive) { clearInterval(starSpawner); return; } const star = document.createElement('div'); star.textContent = '‚≠ê'; star.className = 'star'; star.style.top = `${Math.random() * 85}%`; star.style.left = `${Math.random() * 90}%`; star.onclick = () => { if(!minigameActive) return; score++; scoreEl.textContent = score; star.onclick = null; star.classList.add('popped'); setTimeout(() => star.remove(), 300); }; minigameArea.appendChild(star); }, 500); gameInterval = setInterval(() => { duration--; timerEl.textContent = duration; if (duration <= 0) { clearInterval(gameInterval); clearInterval(starSpawner); endStarCatcher(score); } }, 1000); }
    function endStarCatcher(finalScore) { const earnings = calculateEarnings(finalScore * pillowLevel * 2); money += earnings; showEndScreen(`ÊäìÂà∞‰∫Ü ${finalScore} È°ÜÊòüÊòüÔºÅÁç≤Âæó ${earnings} üí∞ÔºÅ`, `üåô Â•ΩÂ§¢‰∏≠ÊäìÂà∞ ${finalScore} È°ÜÊòüÊòüÔºåÁç≤Âæó ${earnings} üí∞ÔºÅ`, true); }
    function startNightmareEscape() { let clicks = 0; let duration = 4; showMinigame(); minigameTitle.textContent = "üëª Â§¢È≠òÊéôËÑ´ üëª"; minigameInstruction.textContent = "Âø´ÔºÅÁòãÁãÇÈªûÊìäÊåâÈàïÂæûÂ§¢È≠ò‰∏≠ÊéôËÑ´ÔºÅ"; minigameInfoBar.innerHTML = `<span>ÊôÇÈñì: <span id="timer">${duration}</span>s</span> <span>ÈªûÊìä: <span id="score">0</span></span>`; const timerEl = document.getElementById('timer'); const scoreEl = document.getElementById('score'); minigameArea.innerHTML = `<button id="mash-button" style="width: 80%; height: 80px; font-size: 1.5em; background-color: var(--bad-color);">ÊéôËÑ´ÔºÅ</button>`; document.getElementById('mash-button').onclick = () => { if(!minigameActive) return; clicks++; scoreEl.textContent = clicks; }; gameInterval = setInterval(() => { duration--; timerEl.textContent = duration; if (duration <= 0) { clearInterval(gameInterval); endNightmareEscape(clicks); } }, 1000); }
    function endNightmareEscape(finalClicks) { const threshold = 15 + bedLevel - (incenseLevel - 1); let success = finalClicks >= threshold; if (success) { const moneyLost = calculateEarnings(20, true); money = Math.max(0, money - moneyLost); showEndScreen(`ÊàêÂäüÊéôËÑ´‰∫ÜÔºÅ‰ΩÜÈÇÑÊòØÊêçÂ§±‰∫Ü ${moneyLost} üí∞„ÄÇ`, `üëª ÊàêÂäüÊéôËÑ´Â£ûÂ§¢ÔºåÊêçÂ§± ${moneyLost} üí∞„ÄÇ`, success); } else { const moneyLost = calculateEarnings(40, true); money = Math.max(0, money - moneyLost); showEndScreen(`Ë¢´Â§¢È≠òÂêûÂô¨‰∫Ü...ÊêçÂ§±‰∫Ü ${moneyLost} üí∞ÔºÅ`, `üëª Ë¢´Â£ûÂ§¢ÊìäÊïóÔºåÊêçÂ§± ${moneyLost} üí∞„ÄÇ`, success); } }
    function startMemoryTrail() { let sequence = [], playerSequence = [], level = 1; showMinigame(); minigameTitle.textContent = "‚ú® Ë®òÊÜ∂ÊòüËªå ‚ú®"; minigameInstruction.textContent = "Ë®ò‰ΩèÊòüÊòüÈñÉÁàçÁöÑÈ†ÜÂ∫è‰∏¶‰æùÂ∫èÈªûÊìä„ÄÇ"; minigameInfoBar.innerHTML = `<span>Èï∑Â∫¶: <span id="score">1</span></span>`; const scoreEl = document.getElementById('score'); function nextLevel() { minigameArea.style.pointerEvents = 'none'; minigameArea.innerHTML = '<p style="font-size: 1.5em;">Ë´ãË®ò‰ΩèÈ†ÜÂ∫è...</p>'; playerSequence = []; scoreEl.textContent = level; setTimeout(() => { if(!minigameActive && !eventActive) return; minigameArea.innerHTML = ''; let positions = []; const minDistance = 18; for (let i = 0; i < level; i++) { let pos; let validPosition = false; let attempts = 0; while (!validPosition && attempts < 100) { pos = { top: 10 + Math.random() * 75, left: 10 + Math.random() * 80 }; validPosition = true; for (const existingPos of positions) { const dist = Math.sqrt(Math.pow(pos.top - existingPos.top, 2) + Math.pow(pos.left - existingPos.left, 2)); if (dist < minDistance) { validPosition = false; break; } } attempts++; } positions.push(pos); } sequence = positions.map((pos, index) => { const star = document.createElement('div'); star.className = 'memory-star'; star.textContent = '‚úß'; star.style.top = `${pos.top}%`; star.style.left = `${pos.left}%`; star.dataset.index = index; star.onclick = () => playerClick(star); minigameArea.appendChild(star); return star; }); setTimeout(() => minigameArea.style.pointerEvents = 'auto', level * 800); sequence.forEach((star, index) => { setTimeout(() => { star.classList.add('highlight'); setTimeout(() => star.classList.remove('highlight'), 500); }, (index + 1) * 800); }); }, 1500); } function playerClick(clickedStar) { if (playerSequence.length >= sequence.length || !minigameActive) return; const clickedIndex = parseInt(clickedStar.dataset.index); if (sequence[playerSequence.length].dataset.index != clickedIndex) { clickedStar.classList.add('wrong'); endMemoryTrail(level - 1, sequence); return; } playerSequence.push(clickedIndex); clickedStar.classList.add('highlight'); if (playerSequence.length === sequence.length) { level++; setTimeout(nextLevel, 1000); } } nextLevel(); }
    function endMemoryTrail(finalLevel, correctSequence) { if (correctSequence) { correctSequence.forEach((star, index) => { setTimeout(() => star.classList.add('correct-path'), index * 100); }); } const earnings = calculateEarnings(finalLevel * finalLevel * pillowLevel * 2); money += earnings; showEndScreen(`Ë®òÊÜ∂‰∏≠Êñ∑ÔºÅ‰Ω†Ë®ò‰Ωè‰∫Ü ${finalLevel} ÂÄãÁØÄÈªû„ÄÇÁç≤Âæó ${earnings} üí∞ÔºÅ`, `‰Ω†Âú®Ë®òÊÜ∂ÊòüËªå‰∏≠ÈÅîÂà∞‰∫ÜÈï∑Â∫¶ ${finalLevel}ÔºåÁç≤Âæó ${earnings} üí∞„ÄÇ`, finalLevel > 0); }
    function startDreamFishing() { showMinigame(); minigameTitle.textContent = "üé£ Â§¢Â¢ÉÈá£È≠ö üé£"; minigameInstruction.textContent = "Âú®È≠öÊ∏∏Âà∞‰∏≠ÈñìÈá£Á∑ö‰∏ãÊñπÊôÇÔºåÈªûÊìäÁï´Èù¢ÔºÅ"; const fish = document.createElement('div'); fish.textContent = 'üêü'; fish.className = 'fish'; fish.style.top = `${30 + Math.random() * 50}%`; const moveDuration = 2 + Math.random() * 2; fish.style.animation = `moveFish ${moveDuration}s linear infinite alternate`; minigameArea.appendChild(fish); const style = document.createElement('style'); style.innerHTML = `@keyframes moveFish { 0% { left: 5%; transform: scaleX(1); } 49% {transform: scaleX(1);} 50% {transform: scaleX(-1);} 100% { left: 85%; transform: scaleX(-1);} }`; document.head.appendChild(style); minigameArea.onclick = () => { minigameArea.onclick = null; fish.style.animationPlayState = 'paused'; const line = document.createElement('div'); line.className = 'fishing-line'; minigameArea.appendChild(line); setTimeout(() => line.style.height = '100%', 50); setTimeout(() => { if(!minigameActive && !eventActive) return; const fishRect = fish.getBoundingClientRect(); const areaRect = minigameArea.getBoundingClientRect(); const lineX = areaRect.left + (areaRect.width / 2); try{document.head.removeChild(style);}catch(e){} const success = lineX > fishRect.left && lineX < fishRect.right; if (success) fish.classList.add('popped'); endDreamFishing(success); }, 500); }; }
    function endDreamFishing(success) { if (success) { const earnings = calculateEarnings(50 * pillowLevel); money += earnings; showEndScreen(`Èá£Âà∞‰∫ÜÔºÅ‰∏ÄÊ¢ùÈáëÂÖâÈñÉÈñÉÁöÑÈ≠öÔºÅÁç≤Âæó ${earnings} üí∞ÔºÅ`, `ÊàêÂäüÈá£Âà∞Â§¢Â¢ÉÈáëÈ≠öÔºåÁç≤Âæó ${earnings} üí∞„ÄÇ`, true); } else { showEndScreen(`ÂìéÂëÄÔºåËÆìÂÆÉÁµ¶Ê∫ú‰∫ÜÔºÅ`, `Â§¢Â¢ÉÈáëÈ≠öÈÄÉËµ∞‰∫ÜÔºå‰∏ÄÁÑ°ÊâÄÁç≤„ÄÇ`, 'neutral'); } }
    function startTidyEmotions() { let score = 0; let duration = 8 + (incenseLevel - 1); showMinigame(); minigameTitle.textContent = "üòä Êï¥ÁêÜÊÉÖÁ∑í üò≠"; minigameInstruction.textContent = "ÈªûÊìäÁ¨ëËáâ (üòä) Âä†ÂàÜÔºåÈÅøÈñãÂì≠Ëáâ (üò≠)ÔºÅ"; minigameInfoBar.innerHTML = `<span>ÊôÇÈñì: <span id="timer">${duration}</span>s</span> <span>ÂàÜÊï∏: <span id="score">0</span></span>`; const timerEl = document.getElementById('timer'); const scoreEl = document.getElementById('score'); const iconSpawner = setInterval(() => { if (!minigameActive) { clearInterval(iconSpawner); return; } const isGood = Math.random() > 0.4; const icon = document.createElement('div'); icon.className = 'emotion-icon'; icon.textContent = isGood ? 'üòä' : 'üò≠'; icon.style.left = `${Math.random() * 90}%`; icon.style.animationDuration = `${2 + Math.random() * 2}s`; icon.onclick = () => { if(!minigameActive) return; score += isGood ? 1 : -2; scoreEl.textContent = score; icon.onclick = null; icon.classList.add('popped'); setTimeout(() => icon.remove(), 300); }; minigameArea.appendChild(icon); setTimeout(() => icon.remove(), 4000); }, 600); gameInterval = setInterval(() => { duration--; timerEl.textContent = duration; if (duration <= 0) { clearInterval(gameInterval); clearInterval(iconSpawner); endTidyEmotions(score); } }, 1000); }
    function endTidyEmotions(finalScore) { const earnings = calculateEarnings(finalScore * pillowLevel * 3); if (earnings >= 0) { money += earnings; showEndScreen(`Êï¥ÁêÜÂÆåÁï¢ÔºÅÂøÉÊÉÖËÆäÂ•Ω‰∫Ü„ÄÇÁç≤Âæó‰∫Ü ${earnings} üí∞„ÄÇ`, `‰Ω†Êï¥ÁêÜ‰∫ÜÊÉÖÁ∑íÔºåÁç≤Âæó ${earnings} üí∞„ÄÇ`, true); } else { const loss = calculateEarnings(Math.abs(finalScore * 5), true); money = Math.max(0, money - loss); showEndScreen(`Êï¥ÁêÜÂ§±ÊïóÔºåÂøÉÊÉÖÊõ¥‰∫Ç‰∫Ü...ÊêçÂ§±‰∫Ü ${loss} üí∞„ÄÇ`, `Êï¥ÁêÜÊÉÖÁ∑íÂ§±ÊïóÔºåÊêçÂ§± ${loss} üí∞„ÄÇ`, false); } }
    function startMazeQTE() { showMinigame(); minigameTitle.textContent = "üëª Ëø∑ÂÆÆÂ≤îË∑Ø üëª"; minigameInstruction.textContent = "Âø´ÔºÅÊåâ‰∏ãÂ∞çÊáâÁöÑÊñπÂêëÈçµÔºÅ"; minigameArea.style.display = 'flex'; minigameArea.style.flexDirection = 'column'; minigameArea.style.justifyContent = 'center'; minigameArea.innerHTML = `<div id="qte-arrow" style="font-size: 6em; color: yellow; text-shadow: 0 0 10px black;"></div><div id="qte-timer-bar-container"><div id="qte-timer-bar"></div></div>`; const qteArrow = document.getElementById('qte-arrow'); const timerBar = document.getElementById('qte-timer-bar'); const arrows = { 'ArrowUp': '‚¨ÜÔ∏è', 'ArrowDown': '‚¨áÔ∏è', 'ArrowLeft': '‚¨ÖÔ∏è', 'ArrowRight': '‚û°Ô∏è' }; const keys = Object.keys(arrows); const correctKey = keys[Math.floor(Math.random() * keys.length)]; qteArrow.textContent = arrows[correctKey]; setTimeout(() => { timerBar.style.width = '0%'; }, 100); gameTimeout = setTimeout(() => endMazeQTE(false), 2000 + (incenseLevel * 100)); keydownHandler = (e) => { if (keys.includes(e.key)) { e.preventDefault(); endMazeQTE(e.key === correctKey); } }; document.addEventListener('keydown', keydownHandler); if(isTouchDevice) { mobileControlsContainer.innerHTML = `<button class="mobile-btn" data-key="ArrowUp">‚¨ÜÔ∏è</button><button class="mobile-btn" data-key="ArrowLeft">‚¨ÖÔ∏è</button><button class="mobile-btn" data-key="ArrowDown">‚¨áÔ∏è</button><button class="mobile-btn" data-key="ArrowRight">‚û°Ô∏è</button>`; mobileControlsContainer.classList.add('visible'); mobileControlsContainer.onclick = (e) => { if(e.target.dataset.key) { endMazeQTE(e.target.dataset.key === correctKey); } } } }
    function endMazeQTE(success) { minigameArea.style.display = 'block'; const flash = document.createElement('div'); flash.className = 'screen-flash'; flash.style.backgroundColor = success ? 'rgba(144, 238, 144, 0.5)' : 'rgba(255, 99, 71, 0.5)'; document.body.appendChild(flash); setTimeout(() => flash.remove(), 400); if (success) { showEndScreen("ÈÅ∏Â∞ç‰∫ÜË∑ØÔºÅÊö´ÊôÇÂÆâÂÖ®‰∫Ü„ÄÇ", "Âú®Ëø∑ÂÆÆ‰∏≠ÈÅ∏Â∞ç‰∫ÜÊñπÂêëÔºåÊúâÈ©öÁÑ°Èö™„ÄÇ", true); } else { const moneyLost = calculateEarnings(50, true); money = Math.max(0, money - moneyLost); showEndScreen(`ÊòØÊ≠ªË∑ØÔºÅ‰Ω†Ëø∑Â§±Âú®ÂÖ∂‰∏≠...ÊêçÂ§±‰∫Ü ${moneyLost} üí∞„ÄÇ`, `Âú®Ëø∑ÂÆÆ‰∏≠Ëµ∞ÈåØ‰∫ÜË∑ØÔºåÊêçÂ§± ${moneyLost} üí∞„ÄÇ`, false); } }
    function startDodgeShadows() { let duration = 10; showMinigame(); minigameTitle.textContent = "üëª Ë∫≤ÈÅøÈô∞ÂΩ± üëª"; minigameInstruction.textContent = "ÁßªÂãïÊªëÈº†ÊàñÊâãÊåáÔºåÊéßÂà∂ÂÖâÁêÉË∫≤ÈÅøÊéâËêΩÁöÑÈô∞ÂΩ±ÔºÅ"; minigameInfoBar.innerHTML = `<span>Êíê‰Ωè: <span id="timer">${duration}</span>s</span>`; const timerEl = document.getElementById('timer'); const player = document.createElement('div'); player.id = 'player-avatar'; minigameArea.appendChild(player); const movePlayer = (clientX) => { const areaRect = minigameArea.getBoundingClientRect(); player.style.left = `${clientX - areaRect.left - player.offsetWidth / 2}px`; }; mousemoveHandler = (e) => movePlayer(e.clientX); touchMoveHandler = (e) => { e.preventDefault(); if (e.touches[0]) movePlayer(e.touches[0].clientX); }; minigameArea.addEventListener('mousemove', mousemoveHandler); minigameArea.addEventListener('touchmove', touchMoveHandler, { passive: false }); const shadowSpawner = setInterval(() => { if (!minigameActive) { clearInterval(shadowSpawner); return; } const shadow = document.createElement('div'); shadow.className = 'shadow-obstacle'; shadow.style.left = `${Math.random() * 90}%`; shadow.style.animationDuration = `${1.2 + Math.random()}s`; minigameArea.appendChild(shadow); const checkCollision = setInterval(() => { if (!minigameActive) { clearInterval(checkCollision); return; } const playerRect = player.getBoundingClientRect(); const shadowRect = shadow.getBoundingClientRect(); if (playerRect.left < shadowRect.right && playerRect.right > shadowRect.left && playerRect.top < shadowRect.bottom && playerRect.bottom > shadowRect.top) { clearInterval(checkCollision); clearInterval(shadowSpawner); endDodgeShadows(false); } }, 50); setTimeout(() => { clearInterval(checkCollision); shadow.remove(); }, 2200); }, 400); gameInterval = setInterval(() => { duration--; timerEl.textContent = duration; if (duration <= 0) { clearInterval(gameInterval); clearInterval(shadowSpawner); endDodgeShadows(true); } }, 1000); }
    function endDodgeShadows(survived) { if (!minigameActive) return; if (survived) { showEndScreen("‰Ω†ÊàêÂäüÊ¥ª‰∫Ü‰∏ã‰æÜÔºÅÂ§©‰∫Æ‰∫Ü„ÄÇ", "‰Ω†Âú®Èô∞ÂΩ±‰∏≠Â≠òÊ¥ª‰∫Ü‰∏ã‰æÜÔºåÊØ´È´ÆÁÑ°ÂÇ∑„ÄÇ", true); } else { const moneyLost = calculateEarnings(60, true); money = Math.max(0, money - moneyLost); showEndScreen(`Ë¢´Èô∞ÂΩ±Êäì‰Ωè‰∫ÜÔºÅÊêçÂ§±‰∫Ü ${moneyLost} üí∞„ÄÇ`, `‰Ω†Ë¢´Èô∞ÂΩ±ÂêûÂô¨ÔºåÊêçÂ§±‰∫Ü ${moneyLost} üí∞„ÄÇ`, false); } }
    function startDreamWeaving() { let score = 0; let duration = 15 + (incenseLevel - 1); let currentLevel = 0; let requiredClicks = 0; showMinigame(); minigameTitle.textContent = "‚ú® Â§¢Â¢ÉÁ∑®Áπî ‚ú®"; minigameInstruction.textContent = "‰æùÂ∫èÈªûÊìäÊï∏Â≠óÔºåÂ∞áÂ§¢Â¢ÉÁ¢éÁâáÈÄ£Êé•Ëµ∑‰æÜ„ÄÇ"; minigameInfoBar.innerHTML = `<span>ÊôÇÈñì: <span id="timer">${duration}</span>s</span> <span>ÂàÜÊï∏: <span id="score">0</span></span>`; const timerEl = document.getElementById('timer'); const scoreEl = document.getElementById('score'); function nextLevel() { minigameArea.innerHTML = ''; currentLevel++; requiredClicks = 0; let fragmentPositions = []; const numFragments = 2 + currentLevel; const minDistance = 15; for (let i = 1; i <= numFragments; i++) { let pos; let validPosition = false; let attempts = 0; while (!validPosition && attempts < 100) { pos = { top: 10 + Math.random() * 75, left: 10 + Math.random() * 80 }; validPosition = true; for (const existingPos of fragmentPositions) { const dist = Math.sqrt(Math.pow(pos.top - existingPos.top, 2) + Math.pow(pos.left - existingPos.left, 2)); if (dist < minDistance) { validPosition = false; break; } } attempts++; } fragmentPositions.push(pos); const fragment = document.createElement('div'); fragment.className = 'dream-fragment'; fragment.textContent = i; fragment.style.top = `${pos.top}%`; fragment.style.left = `${pos.left}%`; fragment.onclick = () => onFragmentClick(fragment, i); minigameArea.appendChild(fragment); } } function onFragmentClick(element, num) { if (!minigameActive || num !== requiredClicks + 1) return; requiredClicks++; element.classList.add('clicked'); element.onclick = null; if (requiredClicks === (2 + currentLevel)) { score++; scoreEl.textContent = score; nextLevel(); } } gameInterval = setInterval(() => { duration--; timerEl.textContent = duration; if (duration <= 0) { clearInterval(gameInterval); endDreamWeaving(score); } }, 1000); nextLevel(); }
    function endDreamWeaving(finalScore) { const earnings = calculateEarnings(finalScore * finalScore * pillowLevel * 2); money += earnings; showEndScreen(`Á∑®ÁπîÂÆåÊàêÔºÅ‰Ω†ÂÆåÊàê‰∫Ü ${finalScore} ÂÄãÊòüÂ∫ß„ÄÇÁç≤Âæó ${earnings} üí∞ÔºÅ`, `‰Ω†Âú®Â§¢‰∏≠Á∑®Áπî‰∫Ü ${finalScore} ÂÄãÊòüÂ∫ßÔºåÁç≤Âæó ${earnings} üí∞„ÄÇ`, true); }
    function startSleepParalysis() { let progress = 0; let duration = 10; let isHolding = false; showMinigame(); minigameTitle.textContent = "üëª È¨ºÂ£ìÂ∫ä üëª"; minigameInstruction.textContent = "Êåâ‰Ωè [Á©∫ÁôΩÈçµ] Êàñ‰∏ãÊñπÊåâÈàï‰æÜÁ©çËìÑÊÑèÂøóÂäõÔºå‰ΩÜË¶ÅÈÅøÈñãÊÅêÊáºÁöÑËÑàË°ùÔºÅ"; minigameInfoBar.innerHTML = `<span>Ââ©È§òÊôÇÈñì: <span id="timer">${duration}</span>s</span>`; minigameArea.innerHTML = '<div id="paralysis-bar-container"><div id="paralysis-bar"></div></div><div id="paralysis-pulse"></div>'; const timerEl = document.getElementById('timer'); const bar = document.getElementById('paralysis-bar'); const pulse = document.getElementById('paralysis-pulse'); let isPulsing = false; const pulseCheck = setInterval(() => { isPulsing = parseFloat(getComputedStyle(pulse).opacity) > 0.5; }, 50); keydownHandler = e => { if (e.code === 'Space') { e.preventDefault(); if(!isHolding) isHolding = true; } }; keyupHandler = e => { if (e.code === 'Space') { e.preventDefault(); isHolding = false; } }; document.addEventListener('keydown', keydownHandler); document.addEventListener('keyup', keyupHandler); if(isTouchDevice) { mobileControlsContainer.innerHTML = `<button id="mobile-hold-button">Êåâ‰Ωè</button>`; mobileControlsContainer.classList.add('visible'); const holdButton = document.getElementById('mobile-hold-button'); touchStartHandler = e => { e.preventDefault(); isHolding = true; }; touchEndHandler = e => { e.preventDefault(); isHolding = false; }; holdButton.addEventListener('touchstart', touchStartHandler, { passive: false }); holdButton.addEventListener('touchend', touchEndHandler, { passive: false }); } gameInterval = setInterval(() => { if (isHolding) { if (isPulsing) { progress -= 10; } else { progress += 2.5 + (incenseLevel - 1) * 0.2; } } else { progress -= 0.5; } progress = Math.max(0, Math.min(100, progress)); bar.style.width = `${progress}%`; if (progress >= 100) { clearInterval(gameInterval); clearInterval(pulseCheck); endSleepParalysis(true); return; } duration -= 0.05; timerEl.textContent = Math.ceil(duration); if (duration <= 0) { clearInterval(gameInterval); clearInterval(pulseCheck); endSleepParalysis(false); } }, 50); }
    function endSleepParalysis(success) { if (success) { showEndScreen("‰Ω†Êà∞Âãù‰∫ÜÊÅêÊáºÔºåÊàêÂäüÈÜí‰æÜÔºÅ", "‰Ω†ÂæûÈ¨ºÂ£ìÂ∫ä‰∏≠ÊàêÂäüÊéôËÑ´ÔºåÊúâÈ©öÁÑ°Èö™„ÄÇ", true); } else { const moneyLost = calculateEarnings(70, true); money = Math.max(0, money - moneyLost); showEndScreen(`ÊÑèÂøóÂäõËÄóÁõ°...‰Ω†Ë¢´Âõ∞Âú®‰∫ÜÊÅêÊáº‰∏≠„ÄÇÊêçÂ§± ${moneyLost} üí∞„ÄÇ`, `Ë¢´È¨ºÂ£ìÂ∫äÊìäÊïóÔºåÊêçÂ§±‰∫Ü ${moneyLost} üí∞„ÄÇ`, false); } }
    
    // --- 7. ÈÅäÊà≤ÂàùÂßãÂåñ ---
    document.addEventListener('DOMContentLoaded', () => {
        gameContainer = document.getElementById('game-container'); dayCountEl = document.getElementById('day-count'); moneyEl = document.getElementById('money'); goodDreamChanceEl = document.getElementById('good-dream-chance'); gameLogEl = document.getElementById('game-log'); sleepButton = document.getElementById('sleep-button'); bedLevelEl = document.getElementById('bed-level'); pillowLevelEl = document.getElementById('pillow-level'); dreamCatcherLevelEl = document.getElementById('dreamcatcher-level'); incenseLevelEl = document.getElementById('incense-level'); bedUpgradeCostEl = document.getElementById('bed-upgrade-cost'); pillowUpgradeCostEl = document.getElementById('pillow-upgrade-cost'); dreamCatcherUpgradeCostEl = document.getElementById('dreamcatcher-upgrade-cost'); incenseUpgradeCostEl = document.getElementById('incense-upgrade-cost'); upgradeBedButton = document.getElementById('upgrade-bed-button'); upgradePillowButton = document.getElementById('upgrade-pillow-button'); upgradeDreamCatcherButton = document.getElementById('upgrade-dreamcatcher-button'); upgradeIncenseButton = document.getElementById('upgrade-incense-button'); minigameModal = document.getElementById('minigame-modal'); minigameTitle = minigameModal.querySelector('h3'); minigameInstruction = minigameModal.querySelector('p'); minigameInfoBar = minigameModal.querySelector('#minigame-info-bar'); minigameArea = minigameModal.querySelector('#minigame-area'); minigameResultEl = minigameModal.querySelector('#minigame-result'); mobileControlsContainer = minigameModal.querySelector('#mobile-controls-container'); eventModal = document.getElementById('event-modal'); eventResultEl = eventModal.querySelector('#event-result'); cardContainer = document.getElementById('card-container'); goodDreamItemCostEl = document.getElementById('good-dream-item-cost'); badDreamItemCostEl = document.getElementById('bad-dream-item-cost'); buyGoodDreamItemButton = document.getElementById('buy-good-dream-item-button'); buyBadDreamItemButton = document.getElementById('buy-bad-dream-item-button'); merchantModal = document.getElementById('merchant-modal'); merchantTimerEl = document.getElementById('merchant-timer'); merchantItemsEl = merchantModal.querySelector('#merchant-items'); potionEffectStatusEl = document.getElementById('potion-effect-status'); settingsButton = document.getElementById('settings-button'); settingsModal = document.getElementById('settings-modal'); deleteSaveButton = document.getElementById('delete-save-button'); settingsCloseButton = document.getElementById('settings-close-button'); storyModal = document.getElementById('story-modal'); storyModalTitle = document.getElementById('story-modal-title'); storyModalText = document.getElementById('story-modal-text'); storyModalCloseButton = document.getElementById('story-modal-close-button'); endingModal = document.getElementById('ending-modal'); endingText = document.getElementById('ending-text'); endingResetButton = document.getElementById('ending-reset-button'); endingContinueButton = document.getElementById('ending-continue-button'); backpackButton = document.getElementById('backpack-button'); backpackModal = document.getElementById('backpack-modal'); backpackItemsEl = document.getElementById('backpack-items'); backpackCloseButton = document.getElementById('backpack-close-button');
        
        sleepButton.addEventListener('click', goToSleep); upgradeBedButton.addEventListener('click', upgradeBed); upgradePillowButton.addEventListener('click', upgradePillow); upgradeDreamCatcherButton.addEventListener('click', upgradeDreamCatcher); upgradeIncenseButton.addEventListener('click', upgradeIncense);
        buyGoodDreamItemButton.addEventListener('click', () => buyItem('luckyClover', goodDreamItemCost));
        buyBadDreamItemButton.addEventListener('click', () => buyItem('cursedDoll', badDreamItemCost));
        settingsButton.addEventListener('click', () => { settingsModalActive = true; settingsModal.classList.remove('hidden'); updateStatsUI(); });
        settingsCloseButton.addEventListener('click', () => { settingsModalActive = false; settingsModal.classList.add('hidden'); updateStatsUI(); });
        deleteSaveButton.addEventListener('click', deleteSaveAndReset);
        storyModalCloseButton.addEventListener('click', () => { storyModalActive = false; storyModal.classList.add('hidden'); gameContainer.classList.remove('frozen'); saveGameAndUpdateUI(); });
        endingResetButton.addEventListener('click', deleteSaveAndReset);
        endingContinueButton.addEventListener('click', () => { endingActive = false; endingModal.classList.add('hidden'); gameContainer.classList.remove('frozen'); saveGameAndUpdateUI(); });
        backpackButton.addEventListener('click', openBackpack);
        backpackCloseButton.addEventListener('click', closeBackpack);
        backpackItemsEl.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON' && e.target.dataset.itemId) { useItem(e.target.dataset.itemId); } });

        loadGame();
        updateStatsUI(); 
        mainEventInterval = setInterval(triggerRandomEvent, 60000);
    });
    </script>
</body>
</html>