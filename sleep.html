<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>夢境遊戲 - 存檔強化版</title>
    
    <style>
        :root { --dark-bg: #1a1a2e; --container-bg: #16213e; --border-color: #0f3460; --primary-text: #e0e0e0; --highlight-color: #e94560; --good-color: #3f72af; --bad-color: #d9534f; --neutral-color: #f0ad4e; }
        body { font-family: 'Microsoft JhengHei', 'Arial', sans-serif; background-color: var(--dark-bg); color: var(--primary-text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        #game-container { width: 90%; max-width: 700px; background-color: var(--container-bg); padding: 25px; border-radius: 15px; box-shadow: 0 0 20px rgba(255, 255, 255, 0.1); border: 1px solid var(--border-color); transition: filter 0.3s, transform 0.3s; }
        #game-container.frozen { filter: blur(5px); transform: scale(0.98); pointer-events: none; }
        h1, h2 { text-align: center; color: var(--highlight-color); text-shadow: 0 0 5px var(--highlight-color); }
        #player-stats { display: flex; justify-content: space-around; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; font-size: 1.1em; }
        #game-log { background-color: #0f1c2e; border: 1px solid var(--border-color); padding: 15px; height: 150px; overflow-y: scroll; margin-bottom: 20px; border-radius: 5px; scroll-behavior: smooth; }
        button { padding: 12px 25px; font-size: 18px; font-weight: bold; cursor: pointer; border: none; border-radius: 8px; background-color: var(--highlight-color); color: white; transition: background-color 0.3s, transform 0.1s; }
        button:disabled { background-color: #555; cursor: not-allowed; opacity: 0.7; }
        button:not(:disabled):active { transform: translateY(1px); }
        .upgrade-item { background-color: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); padding: 15px; margin-bottom: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .upgrade-item div { flex-basis: 70%; } .upgrade-item button { flex-basis: 25%; } .upgrade-item p { margin: 2px 0; }
        #minigame-modal, #event-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; background-color: rgba(0, 0, 0, 0.7); }
        #minigame-modal:not(.hidden), #event-modal:not(.hidden) { opacity: 1; pointer-events: all; }
        .modal-content { background-color: var(--container-bg); padding: 30px; border-radius: 15px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; text-align: center; transform: scale(0.9); transition: transform 0.3s; }
        #minigame-modal:not(.hidden) .modal-content, #event-modal:not(.hidden) .modal-content { transform: scale(1); }
        #minigame-instruction, #event-instruction { min-height: 20px; color: var(--neutral-color); margin-top: 0; }
        #minigame-info-bar { display: flex; justify-content: space-around; font-size: 1.2em; font-weight: bold; margin-bottom: 15px; min-height: 25px; }
        #minigame-area { position: relative; width: 100%; height: 250px; background-color: #0f1c2e; border-radius: 10px; margin: 15px 0; overflow: hidden; user-select: none; }
        #minigame-result { font-size: 1.5em; margin-top: 20px; font-weight: bold; min-height: 50px; transition: color 0.3s; }
        #card-container { display: flex; justify-content: space-around; perspective: 1000px; margin-top: 20px; }
        .card { width: 100px; height: 150px; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card.is-flipped .card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px; box-sizing: border-box; }
        .card-back { background: linear-gradient(45deg, #6d6d6d, #4f4f4f); font-size: 3em; color: var(--neutral-color); }
        .card-front { background-color: #eee; color: #333; transform: rotateY(180deg); }
        .fortune-name { font-size: 2em; font-weight: bold; }
        .fortune-tagline { font-size: 0.9em; margin-top: 10px; }
        .star { position: absolute; font-size: 3em; cursor: pointer; user-select: none; }
        .emotion-icon { position: absolute; font-size: 3.5em; cursor: pointer; user-select: none; animation: fall linear forwards; }
        .star.popped, .emotion-icon.popped, .fish.popped { animation: pop 0.3s ease-out forwards; }
        @keyframes pop { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }
        #mash-button:active { transform: scale(0.95) translateY(1px); }
        .memory-star { position: absolute; font-size: 2.5em; cursor: pointer; transition: transform 0.2s, text-shadow 0.2s; }
        .memory-star.highlight { text-shadow: 0 0 15px yellow; transform: scale(1.3); }
        .memory-star.wrong { animation: flash-red 0.5s; }
        .memory-star.correct-path { animation: flash-green 0.5s; }
        @keyframes flash-red { 50% { text-shadow: 0 0 15px red; } }
        @keyframes flash-green { 50% { text-shadow: 0 0 15px lightgreen; } }
        #qte-timer-bar-container { width: 100%; height: 10px; background-color: #555; border-radius: 5px; margin-top: 10px; }
        #qte-timer-bar { width: 100%; height: 100%; background-color: var(--neutral-color); border-radius: 5px; transition: width 2s linear; }
        .screen-flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1001; pointer-events: none; animation: flash-anim 0.4s ease-out; }
        @keyframes flash-anim { from { opacity: 0.7; } to { opacity: 0; } }
        #player-avatar, .shadow-obstacle { position: absolute; }
        @keyframes fall { 0% { top: -50px; } 100% { top: 250px; } }
        #player-avatar { bottom: 10px; width: 30px; height: 30px; background-color: var(--good-color); border-radius: 50%; box-shadow: 0 0 10px white; }
        #player-avatar.hit { animation: player-hit 0.5s; }
        @keyframes player-hit { 50% { background-color: var(--bad-color); transform: scale(1.2); } }
        .shadow-obstacle { width: 40px; height: 40px; background-color: #444; border-radius: 10px; animation: fall linear forwards; }
        .fishing-line { position: absolute; width: 2px; height: 0; background-color: white; top: 0; left: 50%; transition: height 0.3s ease-out; }
        .fish { position: absolute; font-size: 2em; }
        .dream-fragment { position: absolute; width: 40px; height: 40px; background-color: rgba(255, 255, 255, 0.1); border: 2px solid var(--neutral-color); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5em; cursor: pointer; transition: background-color 0.2s; }
        .dream-fragment.clicked { background-color: var(--good-color); border-color: lightgreen; }
        #paralysis-bar-container { width: 80%; height: 40px; background-color: #0f1c2e; border: 2px solid #555; border-radius: 10px; margin: 50px auto; }
        #paralysis-bar { width: 0%; height: 100%; background-color: var(--good-color); border-radius: 8px; transition: width 0.1s linear; }
        #paralysis-pulse { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(217, 83, 79, 0.7); opacity: 0; animation: pulse-anim 1.5s ease-in-out infinite; }
        @keyframes pulse-anim { 5% { opacity: 1; } 25% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>夢境遊戲</h1>
        <div id="player-stats">
            <p>金錢: <span id="money">0</span> 💰</p>
            <p>好夢機率: <span id="good-dream-chance">50</span>% ✨</p>
        </div>
        <div id="game-log"></div>
        <div id="controls" style="text-align:center; margin-bottom:25px;">
            <button id="sleep-button">入睡</button>
        </div>
        <div id="upgrades">
            <h2>升級商店</h2>
            <div class="upgrade-item">
                <div>
                    <p><strong>升級床</strong> (等級: <span id="bed-level">1</span>)</p>
                    <p>效果: +5% 好夢機率</p>
                    <p>價格: <span id="bed-upgrade-cost">50</span> 💰</p>
                </div>
                <button id="upgrade-bed-button">升級</button>
            </div>
            <div class="upgrade-item">
                <div>
                    <p><strong>升級枕頭</strong> (等級: <span id="pillow-level">1</span>)</p>
                    <p>效果: 提高金錢獲取量</p>
                    <p>價格: <span id="pillow-upgrade-cost">70</span> 💰</p>
                </div>
                <button id="upgrade-pillow-button">升級</button>
            </div>
            <div class="upgrade-item">
                <div>
                    <p><strong>購買捕夢網</strong> (等級: <span id="dreamcatcher-level">1</span>)</p>
                    <p>效果: 減少壞夢的金錢損失 (每級-10%)</p>
                    <p>價格: <span id="dreamcatcher-upgrade-cost">100</span> 💰</p>
                </div>
                <button id="upgrade-dreamcatcher-button">升級</button>
            </div>
            <div class="upgrade-item">
                <div>
                    <p><strong>購買寧神薰香</strong> (等級: <span id="incense-level">1</span>)</p>
                    <p>效果: 延長好夢時間 / 降低壞夢難度</p>
                    <p>價格: <span id="incense-upgrade-cost">120</span> 💰</p>
                </div>
                <button id="upgrade-incense-button">升級</button>
            </div>
        </div>
        <!-- 新增物品商店 -->
        <div id="item-shop">
            <h2>物品商店</h2>
            <div class="upgrade-item">
                <div>
                    <p><strong>幸運四葉草</strong> (持有: <span id="good-dream-item-count">0</span>)</p>
                    <p>效果: 下次入睡時必定進入好夢 (消耗品)</p>
                    <p>價格: <span id="good-dream-item-cost">150</span> 💰</p>
                </div>
                <button id="buy-good-dream-item-button">購買</button>
            </div>
            <div class="upgrade-item">
                <div>
                    <p><strong>詛咒娃娃</strong> (持有: <span id="bad-dream-item-count">0</span>)</p>
                    <p>效果: 下次入睡時必定進入壞夢 (消耗品)</p>
                    <p>價格: <span id="bad-dream-item-cost">50</span> 💰</p>
                </div>
                <button id="buy-bad-dream-item-button">購買</button>
            </div>
        </div>
    </div>
    
    <div id="minigame-modal" class="hidden">
        <div class="modal-content">
            <h3 id="minigame-title"></h3>
            <p id="minigame-instruction"></p>
            <div id="minigame-info-bar"></div>
            <div id="minigame-area"></div>
            <div id="minigame-result"></div>
        </div>
    </div>

    <div id="event-modal" class="hidden">
        <div class="modal-content">
            <h3 id="event-title">夢境的啟示</h3>
            <p id="event-instruction">似乎有什麼事要發生了... 請選擇一張卡牌，看看你的運勢。</p>
            <div id="card-container"></div>
            <p id="event-result" style="font-size: 1.2em; min-height: 40px; margin-top: 20px;"></p>
        </div>
    </div>

    <script>
    // --- 1. 遊戲狀態與設定 ---
    let money, goodDreamChance, bedLevel, pillowLevel, dreamCatcherLevel, incenseLevel;
    let bedUpgradeCost, pillowUpgradeCost, dreamCatcherUpgradeCost, incenseUpgradeCost;
    let guaranteedGoodDreams, guaranteedBadDreams;
    const goodDreamItemCost = 150, badDreamItemCost = 50;

    let minigameActive = false, eventActive = false;
    let gameInterval, gameTimeout, keydownHandler, keyupHandler, mousemoveHandler;

    const goodDreams = [ { name: '星光捕手', startFunction: startStarCatcher }, { name: '記憶星軌', startFunction: startMemoryTrail }, { name: '夢境釣魚', startFunction: startDreamFishing }, { name: '情緒整理', startFunction: startTidyEmotions }, { name: '夢境編織', startFunction: startDreamWeaving } ];
    const badDreams = [ { name: '夢魘掙脫', startFunction: startNightmareEscape }, { name: '迷宮岔路', startFunction: startMazeQTE }, { name: '躲避陰影', startFunction: startDodgeShadows }, { name: '鬼壓床', startFunction: startSleepParalysis } ];
    const fortunes = [
        { name: '大吉', color: '#ff4757', tagline: '今天將是無與倫比的一天！', effect: () => { const bonus = 50 + 10 * pillowLevel; money += bonus; return `獲得了 ${bonus} 💰 的意外之財！`; } },
        { name: '中吉', color: '#ffa502', tagline: '好運正在向你招手。', effect: () => { goodDreamChance = Math.min(95, goodDreamChance + 10); return `下次入睡的好夢機率提升10%！`; } },
        { name: '小吉', color: '#2ed573', tagline: '微小的幸運，也能帶來快樂。', effect: () => { const bonus = 20 + 5 * pillowLevel; money += bonus; return `撿到了 ${bonus} 💰！`; } },
        { name: '兇', color: '#5352ed', tagline: '烏雲籠罩...看來要小心行事。', effect: () => { const loss = 15 * bedLevel; money = Math.max(0, money - loss); return `不小心遺失了 ${loss} 💰...`; } },
        { name: '大兇', color: '#1e272e', tagline: '諸事不順，破財之相！', effect: () => { money = Math.floor(money * 0.8); return `遭遇迎頭痛擊，損失了20%的財產！`; } }
    ];

    // --- 2. 元素變數宣告 ---
    let gameContainer, moneyEl, goodDreamChanceEl, gameLogEl, sleepButton, bedLevelEl, pillowLevelEl, bedUpgradeCostEl, pillowUpgradeCostEl, upgradeBedButton, upgradePillowButton, minigameModal, minigameTitle, minigameInstruction, minigameInfoBar, minigameArea, minigameResultEl, eventModal, eventResultEl, cardContainer, dreamCatcherLevelEl, dreamCatcherUpgradeCostEl, upgradeDreamCatcherButton, incenseLevelEl, incenseUpgradeCostEl, upgradeIncenseButton, goodDreamItemCountEl, badDreamItemCountEl, goodDreamItemCostEl, badDreamItemCostEl, buyGoodDreamItemButton, buyBadDreamItemButton;

    // --- 3. 核心功能函式 ---
    function logMessage(message) { const p = document.createElement('p'); p.innerHTML = message; gameLogEl.appendChild(p); gameLogEl.scrollTop = gameLogEl.scrollHeight; }
    
    function updateStatsUI() { 
        moneyEl.textContent = money; goodDreamChanceEl.textContent = goodDreamChance; 
        bedLevelEl.textContent = bedLevel; pillowLevelEl.textContent = pillowLevel; dreamCatcherLevelEl.textContent = dreamCatcherLevel; incenseLevelEl.textContent = incenseLevel;
        bedUpgradeCostEl.textContent = bedUpgradeCost; pillowUpgradeCostEl.textContent = pillowUpgradeCost; dreamCatcherUpgradeCostEl.textContent = dreamCatcherUpgradeCost; incenseUpgradeCostEl.textContent = incenseUpgradeCost;
        goodDreamItemCountEl.textContent = guaranteedGoodDreams; badDreamItemCountEl.textContent = guaranteedBadDreams;
        goodDreamItemCostEl.textContent = goodDreamItemCost; badDreamItemCostEl.textContent = badDreamItemCost;

        const buttonsDisabled = minigameActive || eventActive;
        sleepButton.disabled = buttonsDisabled; 
        upgradeBedButton.disabled = money < bedUpgradeCost || buttonsDisabled; 
        upgradePillowButton.disabled = money < pillowUpgradeCost || buttonsDisabled; 
        upgradeDreamCatcherButton.disabled = money < dreamCatcherUpgradeCost || buttonsDisabled;
        upgradeIncenseButton.disabled = money < incenseUpgradeCost || buttonsDisabled;
        buyGoodDreamItemButton.disabled = money < goodDreamItemCost || buttonsDisabled;
        buyBadDreamItemButton.disabled = money < badDreamItemCost || buttonsDisabled;
    }
    
    function goToSleep() {
        let isGoodDream;
        if (guaranteedGoodDreams > 0) {
            isGoodDream = true;
            guaranteedGoodDreams--;
            logMessage("🍀 你使用了幸運四葉草，一陣溫暖的睡意包圍了你...");
        } else if (guaranteedBadDreams > 0) {
            isGoodDream = false;
            guaranteedBadDreams--;
            logMessage("🎎 你拿出了詛咒娃娃，空氣似乎變得冰冷而沉重...");
        } else {
            isGoodDream = Math.random() * 100 < goodDreamChance;
        }
        
        minigameActive = true; 
        saveGame();
        updateStatsUI(); 
        logMessage("你緩緩閉上眼睛，進入了夢鄉..."); 

        setTimeout(() => { 
            const dreamPool = isGoodDream ? goodDreams : badDreams; 
            const selectedDream = dreamPool[Math.floor(Math.random() * dreamPool.length)]; 
            selectedDream.startFunction(); 
        }, 1500); 
    }

    function clearTimersAndListeners() { clearInterval(gameInterval); clearTimeout(gameTimeout); if (keydownHandler) document.removeEventListener('keydown', keydownHandler); if (keyupHandler) document.removeEventListener('keyup', keyupHandler); if (mousemoveHandler) minigameArea.removeEventListener('mousemove', mousemoveHandler); keydownHandler = null; keyupHandler = null; mousemoveHandler = null; gameInterval = null; gameTimeout = null; }
    function showMinigame() { gameContainer.classList.add('frozen'); minigameModal.classList.remove('hidden'); minigameResultEl.innerHTML = ''; minigameInfoBar.innerHTML = ''; minigameArea.innerHTML = ''; minigameInstruction.textContent = ''; minigameArea.style.pointerEvents = 'auto'; }
    function hideMinigame() { gameContainer.classList.remove('frozen'); minigameModal.classList.add('hidden'); if (!eventActive) { minigameActive = false; updateStatsUI(); } }
    
    function showEndScreen(resultText, logText, success) { 
        if (!minigameActive) return; 
        let gameJustEnded = true; 
        minigameActive = false; 
        clearTimersAndListeners(); 
        minigameArea.style.pointerEvents = 'none'; 
        minigameResultEl.textContent = resultText; 
        minigameResultEl.style.color = success === false ? 'var(--bad-color)' : success === true ? 'var(--good-color)' : 'var(--neutral-color)'; 
        if (logText) logMessage(logText); 
        
        saveGame(); // 夢境結束後儲存遊戲狀態
        
        const EVENT_CHANCE = 0.3; 
        if (Math.random() < EVENT_CHANCE) { 
            setTimeout(() => startFortuneEvent(gameJustEnded), 2000); 
        } else { 
            setTimeout(() => { if (gameJustEnded) hideMinigame(); }, 3000); 
        } 
    }
    
    function upgradeBed() { if (money >= bedUpgradeCost) { money -= bedUpgradeCost; bedLevel++; goodDreamChance = Math.min(95, goodDreamChance + 5); bedUpgradeCost = Math.floor(bedUpgradeCost * 1.6); logMessage(`🛠️ 床升級了！等級 ${bedLevel}，好夢機率提升至 ${goodDreamChance}%。`); saveGameAndUpdateUI(); } }
    function upgradePillow() { if (money >= pillowUpgradeCost) { money -= pillowUpgradeCost; pillowLevel++; pillowUpgradeCost = Math.floor(pillowUpgradeCost * 1.7); logMessage(`🛠️ 枕頭升級了！等級 ${pillowLevel}，金錢獲取量提升。`); saveGameAndUpdateUI(); } }
    function upgradeDreamCatcher() { if (money >= dreamCatcherUpgradeCost) { money -= dreamCatcherUpgradeCost; dreamCatcherLevel++; dreamCatcherUpgradeCost = Math.floor(dreamCatcherUpgradeCost * 1.8); logMessage(`🛠️ 捕夢網升級了！等級 ${dreamCatcherLevel}，能抵禦更多壞夢損失。`); saveGameAndUpdateUI(); } }
    function upgradeIncense() { if (money >= incenseUpgradeCost) { money -= incenseUpgradeCost; incenseLevel++; incenseUpgradeCost = Math.floor(incenseUpgradeCost * 1.75); logMessage(`🛠️ 寧神薰香升級了！等級 ${incenseLevel}，夢境變得更安穩。`); saveGameAndUpdateUI(); } }
    
    function buyGoodDreamItem() { if (money >= goodDreamItemCost) { money -= goodDreamItemCost; guaranteedGoodDreams++; logMessage("🛍️ 你購買了一株幸運四葉草！"); saveGameAndUpdateUI(); } }
    function buyBadDreamItem() { if (money >= badDreamItemCost) { money -= badDreamItemCost; guaranteedBadDreams++; logMessage("🛍️ 你購買了一個詭異的詛咒娃娃..."); saveGameAndUpdateUI(); } }

    function startFortuneEvent(gameJustEnded) { eventActive = true; updateStatsUI(); eventModal.classList.remove('hidden'); cardContainer.innerHTML = ''; eventResultEl.textContent = ''; const shuffledFortunes = [...fortunes].sort(() => 0.5 - Math.random()); const selectedFortunes = shuffledFortunes.slice(0, 3); selectedFortunes.forEach(fortune => { const card = document.createElement('div'); card.className = 'card'; const cardInner = document.createElement('div'); cardInner.className = 'card-inner'; const cardBack = document.createElement('div'); cardBack.className = 'card-face card-back'; cardBack.textContent = '❓'; const cardFront = document.createElement('div'); cardFront.className = 'card-face card-front'; cardFront.innerHTML = `<div class="fortune-name" style="color:${fortune.color};">${fortune.name}</div><div class="fortune-tagline">${fortune.tagline}</div>`; cardInner.appendChild(cardBack); cardInner.appendChild(cardFront); card.appendChild(cardInner); card.onclick = () => flipCard(card, fortune); cardContainer.appendChild(card); }); }
    
    function flipCard(clickedCard, chosenFortune) { 
        document.querySelectorAll('.card').forEach(c => c.onclick = null); 
        clickedCard.classList.add('is-flipped'); 
        const effectMessage = chosenFortune.effect(); 
        logMessage(`【運勢：${chosenFortune.name}】${chosenFortune.tagline} ${effectMessage}`); 
        eventResultEl.textContent = effectMessage; 
        
        saveGameAndUpdateUI(); // 卡牌效果可能改變狀態，所以儲存
        
        setTimeout(() => { document.querySelectorAll('.card:not(.is-flipped)').forEach(otherCard => { otherCard.classList.add('is-flipped'); }); }, 1000); 
        setTimeout(() => { eventModal.classList.add('hidden'); eventActive = false; hideMinigame(); }, 4000); 
    }

    // --- 4. 存檔系統 ---
    function saveGame() {
        const gameState = {
            money, goodDreamChance, bedLevel, pillowLevel, dreamCatcherLevel, incenseLevel,
            bedUpgradeCost, pillowUpgradeCost, dreamCatcherUpgradeCost, incenseUpgradeCost,
            guaranteedGoodDreams, guaranteedBadDreams
        };
        localStorage.setItem('dreamGameSaveData', JSON.stringify(gameState));
    }

    function loadGame() {
        const savedData = localStorage.getItem('dreamGameSaveData');
        if (savedData) {
            const gameState = JSON.parse(savedData);
            money = gameState.money || 0;
            goodDreamChance = gameState.goodDreamChance || 50;
            bedLevel = gameState.bedLevel || 1;
            pillowLevel = gameState.pillowLevel || 1;
            dreamCatcherLevel = gameState.dreamCatcherLevel || 1;
            incenseLevel = gameState.incenseLevel || 1;
            bedUpgradeCost = gameState.bedUpgradeCost || 50;
            pillowUpgradeCost = gameState.pillowUpgradeCost || 70;
            dreamCatcherUpgradeCost = gameState.dreamCatcherUpgradeCost || 100;
            incenseUpgradeCost = gameState.incenseUpgradeCost || 120;
            guaranteedGoodDreams = gameState.guaranteedGoodDreams || 0;
            guaranteedBadDreams = gameState.guaranteedBadDreams || 0;
            logMessage("💾 讀取存檔成功！歡迎回來。");
        } else {
            // 初始化新遊戲
            money = 0; goodDreamChance = 50; bedLevel = 1; pillowLevel = 1; dreamCatcherLevel = 1; incenseLevel = 1;
            bedUpgradeCost = 50; pillowUpgradeCost = 70; dreamCatcherUpgradeCost = 100; incenseUpgradeCost = 120;
            guaranteedGoodDreams = 0; guaranteedBadDreams = 0;
            logMessage("歡迎來到夢境遊戲！今晚會是什麼夢呢？");
        }
    }
    
    function saveGameAndUpdateUI() {
        saveGame();
        updateStatsUI();
    }

    // --- 5. 所有小遊戲完整邏輯 (此處程式碼與前一版相同，為節省篇幅已折疊) ---
    function startStarCatcher() { let score = 0; let duration = 7 + (incenseLevel - 1); showMinigame(); minigameTitle.textContent = "✨ 星光捕手 ✨"; minigameInstruction.textContent = "在時間內盡可能點擊出現的星星！"; minigameInfoBar.innerHTML = `<span>時間: <span id="timer">${duration}</span>s</span> <span>分數: <span id="score">0</span></span>`; const timerEl = document.getElementById('timer'); const scoreEl = document.getElementById('score'); const starSpawner = setInterval(() => { if (!minigameActive) { clearInterval(starSpawner); return; } const star = document.createElement('div'); star.textContent = '⭐'; star.className = 'star'; star.style.top = `${Math.random() * 85}%`; star.style.left = `${Math.random() * 90}%`; star.onclick = () => { if(!minigameActive) return; score++; scoreEl.textContent = score; star.onclick = null; star.classList.add('popped'); setTimeout(() => star.remove(), 300); }; minigameArea.appendChild(star); }, 500); gameInterval = setInterval(() => { duration--; timerEl.textContent = duration; if (duration <= 0) { clearInterval(gameInterval); clearInterval(starSpawner); endStarCatcher(score); } }, 1000); }
    function endStarCatcher(finalScore) { const earnings = finalScore * pillowLevel * 2; money += earnings; showEndScreen(`抓到了 ${finalScore} 顆星星！獲得 ${earnings} 💰！`, `🌙 好夢中抓到 ${finalScore} 顆星星，獲得 ${earnings} 💰！`, true); }
    function startNightmareEscape() { let clicks = 0; let duration = 4; showMinigame(); minigameTitle.textContent = "👻 夢魘掙脫 👻"; minigameInstruction.textContent = "快！瘋狂點擊按鈕從夢魘中掙脫！"; minigameInfoBar.innerHTML = `<span>時間: <span id="timer">${duration}</span>s</span> <span>點擊: <span id="score">0</span></span>`; const timerEl = document.getElementById('timer'); const scoreEl = document.getElementById('score'); minigameArea.innerHTML = `<button id="mash-button" style="width: 80%; height: 80px; font-size: 1.5em; background-color: var(--bad-color);">掙脫！</button>`; document.getElementById('mash-button').onclick = () => { if(!minigameActive) return; clicks++; scoreEl.textContent = clicks; }; gameInterval = setInterval(() => { duration--; timerEl.textContent = duration; if (duration <= 0) { clearInterval(gameInterval); endNightmareEscape(clicks); } }, 1000); }
    function endNightmareEscape(finalClicks) { const threshold = 15 + bedLevel - (incenseLevel - 1); let moneyLost = 0; const lossReduction = 1 - (dreamCatcherLevel - 1) * 0.1; if (finalClicks >= threshold) { moneyLost = Math.round(5 * pillowLevel * lossReduction); money = Math.max(0, money - moneyLost); showEndScreen(`成功掙脫了！但還是損失了 ${moneyLost} 💰。`, `👻 成功掙脫壞夢，損失 ${moneyLost} 💰。`, true); } else { moneyLost = Math.round(15 * pillowLevel * lossReduction); money = Math.max(0, money - moneyLost); showEndScreen(`被夢魘吞噬了...損失了 ${moneyLost} 💰！`, `👻 被壞夢擊敗，損失 ${moneyLost} 💰。`, false); } }
    function startMemoryTrail() { let sequence = [], playerSequence = [], level = 1; showMinigame(); minigameTitle.textContent = "✨ 記憶星軌 ✨"; minigameInstruction.textContent = "記住星星閃爍的順序並依序點擊。"; minigameInfoBar.innerHTML = `<span>長度: <span id="score">1</span></span>`; const scoreEl = document.getElementById('score'); function nextLevel() { minigameArea.style.pointerEvents = 'none'; minigameArea.innerHTML = '<p style="font-size: 1.5em;">請記住順序...</p>'; playerSequence = []; scoreEl.textContent = level; setTimeout(() => { if(!minigameActive && !eventActive) return; minigameArea.innerHTML = ''; let positions = []; for (let i = 0; i < level; i++) { positions.push({ top: `${10 + Math.random() * 80}%`, left: `${10 + Math.random() * 80}%` }); } sequence = positions.map((pos, index) => { const star = document.createElement('div'); star.className = 'memory-star'; star.textContent = '✧'; star.style.top = pos.top; star.style.left = pos.left; star.dataset.index = index; star.onclick = () => playerClick(star); minigameArea.appendChild(star); return star; }); setTimeout(() => minigameArea.style.pointerEvents = 'auto', level * 800); sequence.forEach((star, index) => { setTimeout(() => { star.classList.add('highlight'); setTimeout(() => star.classList.remove('highlight'), 500); }, (index + 1) * 800); }); }, 1500); } function playerClick(clickedStar) { if (playerSequence.length >= sequence.length || !minigameActive) return; const clickedIndex = parseInt(clickedStar.dataset.index); if (sequence[playerSequence.length].dataset.index != clickedIndex) { clickedStar.classList.add('wrong'); endMemoryTrail(level - 1, sequence); return; } playerSequence.push(clickedIndex); clickedStar.classList.add('highlight'); if (playerSequence.length === sequence.length) { level++; setTimeout(nextLevel, 1000); } } nextLevel(); }
    function endMemoryTrail(finalLevel, correctSequence) { if (correctSequence) { correctSequence.forEach((star, index) => { setTimeout(() => star.classList.add('correct-path'), index * 100); }); } const earnings = finalLevel * finalLevel * pillowLevel * 2; money += earnings; showEndScreen(`記憶中斷！你記住了 ${finalLevel} 個節點。獲得 ${earnings} 💰！`, `你在記憶星軌中達到了長度 ${finalLevel}，獲得 ${earnings} 💰。`, finalLevel > 0); }
    function startDreamFishing() { showMinigame(); minigameTitle.textContent = "🎣 夢境釣魚 🎣"; minigameInstruction.textContent = "在魚游到中間釣線下方時，點擊畫面！"; const fish = document.createElement('div'); fish.textContent = '🐟'; fish.className = 'fish'; fish.style.top = `${30 + Math.random() * 50}%`; const moveDuration = 2 + Math.random() * 2; fish.style.animation = `moveFish ${moveDuration}s linear infinite alternate`; minigameArea.appendChild(fish); const style = document.createElement('style'); style.innerHTML = `@keyframes moveFish { 0% { left: 5%; transform: scaleX(1); } 49% {transform: scaleX(1);} 50% {transform: scaleX(-1);} 100% { left: 85%; transform: scaleX(-1);} }`; document.head.appendChild(style); minigameArea.onclick = () => { minigameArea.onclick = null; fish.style.animationPlayState = 'paused'; const line = document.createElement('div'); line.className = 'fishing-line'; minigameArea.appendChild(line); setTimeout(() => line.style.height = '100%', 50); setTimeout(() => { if(!minigameActive && !eventActive) return; const fishRect = fish.getBoundingClientRect(); const areaRect = minigameArea.getBoundingClientRect(); const lineX = areaRect.left + (areaRect.width / 2); document.head.removeChild(style); const success = lineX > fishRect.left && lineX < fishRect.right; if (success) fish.classList.add('popped'); endDreamFishing(success); }, 500); }; }
    function endDreamFishing(success) { if (success) { const earnings = 50 * pillowLevel; money += earnings; showEndScreen(`釣到了！一條金光閃閃的魚！獲得 ${earnings} 💰！`, `成功釣到夢境金魚，獲得 ${earnings} 💰。`, true); } else { showEndScreen(`哎呀，讓它給溜了！`, `夢境金魚逃走了，一無所獲。`, 'neutral'); } }
    function startTidyEmotions() { let score = 0; let duration = 8 + (incenseLevel - 1); showMinigame(); minigameTitle.textContent = "😊 整理情緒 😭"; minigameInstruction.textContent = "點擊笑臉 (😊) 加分，避開哭臉 (😭)！"; minigameInfoBar.innerHTML = `<span>時間: <span id="timer">${duration}</span>s</span> <span>分數: <span id="score">0</span></span>`; const timerEl = document.getElementById('timer'); const scoreEl = document.getElementById('score'); const iconSpawner = setInterval(() => { if (!minigameActive) { clearInterval(iconSpawner); return; } const isGood = Math.random() > 0.4; const icon = document.createElement('div'); icon.className = 'emotion-icon'; icon.textContent = isGood ? '😊' : '😭'; icon.style.left = `${Math.random() * 90}%`; icon.style.animationDuration = `${2 + Math.random() * 2}s`; icon.onclick = () => { if(!minigameActive) return; score += isGood ? 1 : -2; scoreEl.textContent = score; icon.onclick = null; icon.classList.add('popped'); setTimeout(() => icon.remove(), 300); }; minigameArea.appendChild(icon); setTimeout(() => icon.remove(), 4000); }, 600); gameInterval = setInterval(() => { duration--; timerEl.textContent = duration; if (duration <= 0) { clearInterval(gameInterval); clearInterval(iconSpawner); endTidyEmotions(score); } }, 1000); }
    function endTidyEmotions(finalScore) { const earnings = finalScore * pillowLevel * 3; money = Math.max(0, money + earnings); if (earnings > 0) { showEndScreen(`整理完畢！心情變好了。獲得了 ${earnings} 💰。`, `你整理了情緒，獲得 ${earnings} 💰。`, true); } else { showEndScreen(`整理失敗，心情更亂了...損失了 ${-earnings} 💰。`, `整理情緒失敗，損失 ${-earnings} 💰。`, false); } }
    function startMazeQTE() { showMinigame(); minigameTitle.textContent = "👻 迷宮岔路 👻"; minigameInstruction.textContent = "快！在時間內按下對應的方向鍵！"; minigameArea.innerHTML = `<div id="qte-arrow" style="font-size: 8em; color: yellow; text-shadow: 0 0 10px black;"></div><div id="qte-timer-bar-container"><div id="qte-timer-bar"></div></div>`; const qteArrow = document.getElementById('qte-arrow'); const timerBar = document.getElementById('qte-timer-bar'); const arrows = { 'ArrowUp': '⬆️', 'ArrowDown': '⬇️', 'ArrowLeft': '⬅️', 'ArrowRight': '➡️' }; const keys = Object.keys(arrows); const correctKey = keys[Math.random() * keys.length | 0]; qteArrow.textContent = arrows[correctKey]; setTimeout(() => { timerBar.style.width = '0%'; }, 100); gameTimeout = setTimeout(() => endMazeQTE(false), 2000); keydownHandler = (e) => { if (keys.includes(e.key)) { e.preventDefault(); endMazeQTE(e.key === correctKey); } }; document.addEventListener('keydown', keydownHandler); }
    function endMazeQTE(success) { const flash = document.createElement('div'); flash.className = 'screen-flash'; flash.style.backgroundColor = success ? 'rgba(144, 238, 144, 0.5)' : 'rgba(255, 99, 71, 0.5)'; document.body.appendChild(flash); setTimeout(() => flash.remove(), 400); if (success) { showEndScreen("選對了路！暫時安全了。", "在迷宮中選對了方向，有驚無險。", true); } else { const moneyLost = Math.round(20 * pillowLevel * (1 - (dreamCatcherLevel - 1) * 0.1)); money = Math.max(0, money - moneyLost); showEndScreen(`是死路！你迷失在其中...損失了 ${moneyLost} 💰。`, `在迷宮中走錯了路，損失 ${moneyLost} 💰。`, false); } }
    function startDodgeShadows() { let duration = 10; showMinigame(); minigameTitle.textContent = "👻 躲避陰影 👻"; minigameInstruction.textContent = "移動滑鼠，控制光球躲避掉落的陰影！"; minigameInfoBar.innerHTML = `<span>撐住: <span id="timer">${duration}</span>s</span>`; const timerEl = document.getElementById('timer'); const player = document.createElement('div'); player.id = 'player-avatar'; minigameArea.appendChild(player); mousemoveHandler = (e) => { const areaRect = minigameArea.getBoundingClientRect(); player.style.left = `${e.clientX - areaRect.left - player.offsetWidth / 2}px`; }; minigameArea.addEventListener('mousemove', mousemoveHandler); const shadowSpawner = setInterval(() => { if (!minigameActive) { clearInterval(shadowSpawner); return; } const shadow = document.createElement('div'); shadow.className = 'shadow-obstacle'; shadow.style.left = `${Math.random() * 90}%`; shadow.style.animationDuration = `${1.2 + Math.random()}s`; minigameArea.appendChild(shadow); const checkCollision = setInterval(() => { if (!minigameActive) { clearInterval(checkCollision); return; } const playerRect = player.getBoundingClientRect(); const shadowRect = shadow.getBoundingClientRect(); if (playerRect.left < shadowRect.right && playerRect.right > shadowRect.left && playerRect.top < shadowRect.bottom && playerRect.bottom > shadowRect.top) { clearInterval(checkCollision); endDodgeShadows(false); } }, 50); setTimeout(() => { clearInterval(checkCollision); shadow.remove(); }, 2200); }, 400); gameInterval = setInterval(() => { duration--; timerEl.textContent = duration; if (duration <= 0) { clearInterval(gameInterval); clearInterval(shadowSpawner); endDodgeShadows(true); } }, 1000); }
    function endDodgeShadows(survived) { if (!minigameActive) return; if (survived) { showEndScreen("你成功活了下來！天亮了。", "你在陰影中存活了下來，毫髮無傷。", true); } else { const moneyLost = Math.round(25 * pillowLevel * (1 - (dreamCatcherLevel - 1) * 0.1)); money = Math.max(0, money - moneyLost); showEndScreen(`被陰影抓住了！損失了 ${moneyLost} 💰。`, `你被陰影吞噬，損失了 ${moneyLost} 💰。`, false); } }
    function startDreamWeaving() { let score = 0; let duration = 15 + (incenseLevel - 1); let currentLevel = 0; let requiredClicks = 0; let lastClicked = null; showMinigame(); minigameTitle.textContent = "✨ 夢境編織 ✨"; minigameInstruction.textContent = "依序點擊數字，將夢境碎片連接起來。"; minigameInfoBar.innerHTML = `<span>時間: <span id="timer">${duration}</span>s</span> <span>分數: <span id="score">0</span></span>`; const timerEl = document.getElementById('timer'); const scoreEl = document.getElementById('score'); function nextLevel() { minigameArea.innerHTML = ''; lastClicked = null; currentLevel++; requiredClicks = 0; const numFragments = 2 + currentLevel; for (let i = 1; i <= numFragments; i++) { const fragment = document.createElement('div'); fragment.className = 'dream-fragment'; fragment.textContent = i; fragment.style.top = `${10 + Math.random() * 75}%`; fragment.style.left = `${10 + Math.random() * 80}%`; fragment.onclick = () => onFragmentClick(fragment, i); minigameArea.appendChild(fragment); } } function onFragmentClick(element, num) { if (!minigameActive || num !== requiredClicks + 1) return; requiredClicks++; element.classList.add('clicked'); element.onclick = null; if (lastClicked) { /* 可選：畫線 */ } lastClicked = element; if (requiredClicks === (2 + currentLevel)) { score++; scoreEl.textContent = score; nextLevel(); } } gameInterval = setInterval(() => { duration--; timerEl.textContent = duration; if (duration <= 0) { clearInterval(gameInterval); endDreamWeaving(score); } }, 1000); nextLevel(); }
    function endDreamWeaving(finalScore) { const earnings = finalScore * finalScore * pillowLevel * 2; money += earnings; showEndScreen(`編織完成！你完成了 ${finalScore} 個星座。獲得 ${earnings} 💰！`, `你在夢中編織了 ${finalScore} 個星座，獲得 ${earnings} 💰。`, true); }
    function startSleepParalysis() { let progress = 0; let duration = 10; let isHolding = false; showMinigame(); minigameTitle.textContent = "👻 鬼壓床 👻"; minigameInstruction.textContent = "按住 [空白鍵] 來積蓄意志力，但要避開恐懼的脈衝！"; minigameInfoBar.innerHTML = `<span>剩餘時間: <span id="timer">${duration}</span>s</span>`; minigameArea.innerHTML = '<div id="paralysis-bar-container"><div id="paralysis-bar"></div></div><div id="paralysis-pulse"></div>'; const timerEl = document.getElementById('timer'); const bar = document.getElementById('paralysis-bar'); const pulse = document.getElementById('paralysis-pulse'); let isPulsing = false; const pulseCheck = setInterval(() => { isPulsing = parseFloat(getComputedStyle(pulse).opacity) > 0.5; }, 50); keydownHandler = e => { if (e.code === 'Space' && !isHolding) { isHolding = true; } }; keyupHandler = e => { if (e.code === 'Space') { isHolding = false; } }; document.addEventListener('keydown', keydownHandler); document.addEventListener('keyup', keyupHandler); gameInterval = setInterval(() => { if (isHolding) { if (isPulsing) { progress -= 10; } else { progress += 2.5 + (incenseLevel - 1) * 0.2; } } else { progress -= 0.5; } progress = Math.max(0, Math.min(100, progress)); bar.style.width = `${progress}%`; if (progress >= 100) { clearInterval(gameInterval); clearInterval(pulseCheck); endSleepParalysis(true); return; } duration -= 0.05; timerEl.textContent = Math.ceil(duration); if (duration <= 0) { clearInterval(gameInterval); clearInterval(pulseCheck); endSleepParalysis(false); } }, 50); }
    function endSleepParalysis(success) { if (success) { showEndScreen("你戰勝了恐懼，成功醒來！", "你從鬼壓床中成功掙脫，有驚無險。", true); } else { const moneyLost = Math.round(30 * pillowLevel * (1 - (dreamCatcherLevel - 1) * 0.1)); money = Math.max(0, money - moneyLost); showEndScreen(`意志力耗盡...你被困在了恐懼中。損失 ${moneyLost} 💰。`, `被鬼壓床擊敗，損失了 ${moneyLost} 💰。`, false); } }


    // --- 6. 遊戲初始化 ---
    document.addEventListener('DOMContentLoaded', () => {
        // 抓取所有元素
        gameContainer = document.getElementById('game-container'); moneyEl = document.getElementById('money'); goodDreamChanceEl = document.getElementById('good-dream-chance'); gameLogEl = document.getElementById('game-log'); sleepButton = document.getElementById('sleep-button'); bedLevelEl = document.getElementById('bed-level'); pillowLevelEl = document.getElementById('pillow-level'); bedUpgradeCostEl = document.getElementById('bed-upgrade-cost'); pillowUpgradeCostEl = document.getElementById('pillow-upgrade-cost'); upgradeBedButton = document.getElementById('upgrade-bed-button'); upgradePillowButton = document.getElementById('upgrade-pillow-button'); minigameModal = document.getElementById('minigame-modal'); minigameTitle = document.getElementById('minigame-title'); minigameInstruction = document.getElementById('minigame-instruction'); minigameInfoBar = document.getElementById('minigame-info-bar'); minigameArea = document.getElementById('minigame-area'); minigameResultEl = document.getElementById('minigame-result');
        eventModal = document.getElementById('event-modal'); eventResultEl = document.getElementById('event-result'); cardContainer = document.getElementById('card-container');
        dreamCatcherLevelEl = document.getElementById('dreamcatcher-level'); dreamCatcherUpgradeCostEl = document.getElementById('dreamcatcher-upgrade-cost'); upgradeDreamCatcherButton = document.getElementById('upgrade-dreamcatcher-button');
        incenseLevelEl = document.getElementById('incense-level'); incenseUpgradeCostEl = document.getElementById('incense-upgrade-cost'); upgradeIncenseButton = document.getElementById('upgrade-incense-button');
        goodDreamItemCountEl = document.getElementById('good-dream-item-count'); badDreamItemCountEl = document.getElementById('bad-dream-item-count');
        goodDreamItemCostEl = document.getElementById('good-dream-item-cost'); badDreamItemCostEl = document.getElementById('bad-dream-item-cost');
        buyGoodDreamItemButton = document.getElementById('buy-good-dream-item-button'); buyBadDreamItemButton = document.getElementById('buy-bad-dream-item-button');

        // 綁定事件監聽器
        sleepButton.addEventListener('click', goToSleep); 
        upgradeBedButton.addEventListener('click', upgradeBed); 
        upgradePillowButton.addEventListener('click', upgradePillow);
        upgradeDreamCatcherButton.addEventListener('click', upgradeDreamCatcher);
        upgradeIncenseButton.addEventListener('click', upgradeIncense);
        buyGoodDreamItemButton.addEventListener('click', buyGoodDreamItem);
        buyBadDreamItemButton.addEventListener('click', buyBadDreamItem);

        // 讀取遊戲或初始化
        loadGame();
        // 更新UI
        updateStatsUI(); 
    });
    </script>
</body>
</html>```