<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤¢å¢ƒéŠæˆ² - å­˜æª”å¼·åŒ–ç‰ˆ</title>
    
    <style>
        :root { --dark-bg: #1a1a2e; --container-bg: #16213e; --border-color: #0f3460; --primary-text: #e0e0e0; --highlight-color: #e94560; --good-color: #3f72af; --bad-color: #d9534f; --neutral-color: #f0ad4e; }
        body { font-family: 'Microsoft JhengHei', 'Arial', sans-serif; background-color: var(--dark-bg); color: var(--primary-text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        #game-container { width: 90%; max-width: 700px; background-color: var(--container-bg); padding: 25px; border-radius: 15px; box-shadow: 0 0 20px rgba(255, 255, 255, 0.1); border: 1px solid var(--border-color); transition: filter 0.3s, transform 0.3s; }
        #game-container.frozen { filter: blur(5px); transform: scale(0.98); pointer-events: none; }
        h1, h2 { text-align: center; color: var(--highlight-color); text-shadow: 0 0 5px var(--highlight-color); }
        #player-stats { display: flex; justify-content: space-around; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; font-size: 1.1em; }
        #game-log { background-color: #0f1c2e; border: 1px solid var(--border-color); padding: 15px; height: 150px; overflow-y: scroll; margin-bottom: 20px; border-radius: 5px; scroll-behavior: smooth; }
        button { padding: 12px 25px; font-size: 18px; font-weight: bold; cursor: pointer; border: none; border-radius: 8px; background-color: var(--highlight-color); color: white; transition: background-color 0.3s, transform 0.1s; }
        button:disabled { background-color: #555; cursor: not-allowed; opacity: 0.7; }
        button:not(:disabled):active { transform: translateY(1px); }
        .upgrade-item { background-color: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); padding: 15px; margin-bottom: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .upgrade-item div { flex-basis: 70%; } .upgrade-item button { flex-basis: 25%; } .upgrade-item p { margin: 2px 0; }
        #minigame-modal, #event-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; background-color: rgba(0, 0, 0, 0.7); }
        #minigame-modal:not(.hidden), #event-modal:not(.hidden) { opacity: 1; pointer-events: all; }
        .modal-content { background-color: var(--container-bg); padding: 30px; border-radius: 15px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; text-align: center; transform: scale(0.9); transition: transform 0.3s; }
        #minigame-modal:not(.hidden) .modal-content, #event-modal:not(.hidden) .modal-content { transform: scale(1); }
        #minigame-instruction, #event-instruction { min-height: 20px; color: var(--neutral-color); margin-top: 0; }
        #minigame-info-bar { display: flex; justify-content: space-around; font-size: 1.2em; font-weight: bold; margin-bottom: 15px; min-height: 25px; }
        #minigame-area { position: relative; width: 100%; height: 250px; background-color: #0f1c2e; border-radius: 10px; margin: 15px 0; overflow: hidden; user-select: none; }
        #minigame-result { font-size: 1.5em; margin-top: 20px; font-weight: bold; min-height: 50px; transition: color 0.3s; }
        #card-container { display: flex; justify-content: space-around; perspective: 1000px; margin-top: 20px; }
        .card { width: 100px; height: 150px; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card.is-flipped .card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px; box-sizing: border-box; }
        .card-back { background: linear-gradient(45deg, #6d6d6d, #4f4f4f); font-size: 3em; color: var(--neutral-color); }
        .card-front { background-color: #eee; color: #333; transform: rotateY(180deg); }
        .fortune-name { font-size: 2em; font-weight: bold; }
        .fortune-tagline { font-size: 0.9em; margin-top: 10px; }
        .star { position: absolute; font-size: 3em; cursor: pointer; user-select: none; }
        .emotion-icon { position: absolute; font-size: 3.5em; cursor: pointer; user-select: none; animation: fall linear forwards; }
        .star.popped, .emotion-icon.popped, .fish.popped { animation: pop 0.3s ease-out forwards; }
        @keyframes pop { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }
        #mash-button:active { transform: scale(0.95) translateY(1px); }
        .memory-star { position: absolute; font-size: 2.5em; cursor: pointer; transition: transform 0.2s, text-shadow 0.2s; }
        .memory-star.highlight { text-shadow: 0 0 15px yellow; transform: scale(1.3); }
        .memory-star.wrong { animation: flash-red 0.5s; }
        .memory-star.correct-path { animation: flash-green 0.5s; }
        @keyframes flash-red { 50% { text-shadow: 0 0 15px red; } }
        @keyframes flash-green { 50% { text-shadow: 0 0 15px lightgreen; } }
        #qte-timer-bar-container { width: 100%; height: 10px; background-color: #555; border-radius: 5px; margin-top: 10px; }
        #qte-timer-bar { width: 100%; height: 100%; background-color: var(--neutral-color); border-radius: 5px; transition: width 2s linear; }
        .screen-flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1001; pointer-events: none; animation: flash-anim 0.4s ease-out; }
        @keyframes flash-anim { from { opacity: 0.7; } to { opacity: 0; } }
        #player-avatar, .shadow-obstacle { position: absolute; }
        @keyframes fall { 0% { top: -50px; } 100% { top: 250px; } }
        #player-avatar { bottom: 10px; width: 30px; height: 30px; background-color: var(--good-color); border-radius: 50%; box-shadow: 0 0 10px white; }
        #player-avatar.hit { animation: player-hit 0.5s; }
        @keyframes player-hit { 50% { background-color: var(--bad-color); transform: scale(1.2); } }
        .shadow-obstacle { width: 40px; height: 40px; background-color: #444; border-radius: 10px; animation: fall linear forwards; }
        .fishing-line { position: absolute; width: 2px; height: 0; background-color: white; top: 0; left: 50%; transition: height 0.3s ease-out; }
        .fish { position: absolute; font-size: 2em; }
        .dream-fragment { position: absolute; width: 40px; height: 40px; background-color: rgba(255, 255, 255, 0.1); border: 2px solid var(--neutral-color); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5em; cursor: pointer; transition: background-color 0.2s; }
        .dream-fragment.clicked { background-color: var(--good-color); border-color: lightgreen; }
        #paralysis-bar-container { width: 80%; height: 40px; background-color: #0f1c2e; border: 2px solid #555; border-radius: 10px; margin: 50px auto; }
        #paralysis-bar { width: 0%; height: 100%; background-color: var(--good-color); border-radius: 8px; transition: width 0.1s linear; }
        #paralysis-pulse { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(217, 83, 79, 0.7); opacity: 0; animation: pulse-anim 1.5s ease-in-out infinite; }
        @keyframes pulse-anim { 5% { opacity: 1; } 25% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>å¤¢å¢ƒéŠæˆ²</h1>
        <div id="player-stats">
            <p>é‡‘éŒ¢: <span id="money">0</span> ğŸ’°</p>
            <p>å¥½å¤¢æ©Ÿç‡: <span id="good-dream-chance">50</span>% âœ¨</p>
        </div>
        <div id="game-log"></div>
        <div id="controls" style="text-align:center; margin-bottom:25px;">
            <button id="sleep-button">å…¥ç¡</button>
        </div>
        <div id="upgrades">
            <h2>å‡ç´šå•†åº—</h2>
            <div class="upgrade-item">
                <div>
                    <p><strong>å‡ç´šåºŠ</strong> (ç­‰ç´š: <span id="bed-level">1</span>)</p>
                    <p>æ•ˆæœ: +5% å¥½å¤¢æ©Ÿç‡</p>
                    <p>åƒ¹æ ¼: <span id="bed-upgrade-cost">50</span> ğŸ’°</p>
                </div>
                <button id="upgrade-bed-button">å‡ç´š</button>
            </div>
            <div class="upgrade-item">
                <div>
                    <p><strong>å‡ç´šæ•é ­</strong> (ç­‰ç´š: <span id="pillow-level">1</span>)</p>
                    <p>æ•ˆæœ: æé«˜é‡‘éŒ¢ç²å–é‡</p>
                    <p>åƒ¹æ ¼: <span id="pillow-upgrade-cost">70</span> ğŸ’°</p>
                </div>
                <button id="upgrade-pillow-button">å‡ç´š</button>
            </div>
            <div class="upgrade-item">
                <div>
                    <p><strong>è³¼è²·æ•å¤¢ç¶²</strong> (ç­‰ç´š: <span id="dreamcatcher-level">1</span>)</p>
                    <p>æ•ˆæœ: æ¸›å°‘å£å¤¢çš„é‡‘éŒ¢æå¤± (æ¯ç´š-10%)</p>
                    <p>åƒ¹æ ¼: <span id="dreamcatcher-upgrade-cost">100</span> ğŸ’°</p>
                </div>
                <button id="upgrade-dreamcatcher-button">å‡ç´š</button>
            </div>
            <div class="upgrade-item">
                <div>
                    <p><strong>è³¼è²·å¯§ç¥è–°é¦™</strong> (ç­‰ç´š: <span id="incense-level">1</span>)</p>
                    <p>æ•ˆæœ: å»¶é•·å¥½å¤¢æ™‚é–“ / é™ä½å£å¤¢é›£åº¦</p>
                    <p>åƒ¹æ ¼: <span id="incense-upgrade-cost">120</span> ğŸ’°</p>
                </div>
                <button id="upgrade-incense-button">å‡ç´š</button>
            </div>
        </div>
        <!-- æ–°å¢ç‰©å“å•†åº— -->
        <div id="item-shop">
            <h2>ç‰©å“å•†åº—</h2>
            <div class="upgrade-item">
                <div>
                    <p><strong>å¹¸é‹å››è‘‰è‰</strong> (æŒæœ‰: <span id="good-dream-item-count">0</span>)</p>
                    <p>æ•ˆæœ: ä¸‹æ¬¡å…¥ç¡æ™‚å¿…å®šé€²å…¥å¥½å¤¢ (æ¶ˆè€—å“)</p>
                    <p>åƒ¹æ ¼: <span id="good-dream-item-cost">150</span> ğŸ’°</p>
                </div>
                <button id="buy-good-dream-item-button">è³¼è²·</button>
            </div>
            <div class="upgrade-item">
                <div>
                    <p><strong>è©›å’’å¨ƒå¨ƒ</strong> (æŒæœ‰: <span id="bad-dream-item-count">0</span>)</p>
                    <p>æ•ˆæœ: ä¸‹æ¬¡å…¥ç¡æ™‚å¿…å®šé€²å…¥å£å¤¢ (æ¶ˆè€—å“)</p>
                    <p>åƒ¹æ ¼: <span id="bad-dream-item-cost">50</span> ğŸ’°</p>
                </div>
                <button id="buy-bad-dream-item-button">è³¼è²·</button>
            </div>
        </div>
    </div>
    
    <div id="minigame-modal" class="hidden">
        <div class="modal-content">
            <h3 id="minigame-title"></h3>
            <p id="minigame-instruction"></p>
            <div id="minigame-info-bar"></div>
            <div id="minigame-area"></div>
            <div id="minigame-result"></div>
        </div>
    </div>

    <div id="event-modal" class="hidden">
        <div class="modal-content">
            <h3 id="event-title">å¤¢å¢ƒçš„å•Ÿç¤º</h3>
            <p id="event-instruction">ä¼¼ä¹æœ‰ä»€éº¼äº‹è¦ç™¼ç”Ÿäº†... è«‹é¸æ“‡ä¸€å¼µå¡ç‰Œï¼Œçœ‹çœ‹ä½ çš„é‹å‹¢ã€‚</p>
            <div id="card-container"></div>
            <p id="event-result" style="font-size: 1.2em; min-height: 40px; margin-top: 20px;"></p>
        </div>
    </div>

    <script>
    // --- 1. éŠæˆ²ç‹€æ…‹èˆ‡è¨­å®š ---
    let money, goodDreamChance, bedLevel, pillowLevel, dreamCatcherLevel, incenseLevel;
    let bedUpgradeCost, pillowUpgradeCost, dreamCatcherUpgradeCost, incenseUpgradeCost;
    let guaranteedGoodDreams, guaranteedBadDreams;
    const goodDreamItemCost = 150, badDreamItemCost = 50;

    let minigameActive = false, eventActive = false;
    let gameInterval, gameTimeout, keydownHandler, keyupHandler, mousemoveHandler;

    const goodDreams = [ { name: 'æ˜Ÿå…‰æ•æ‰‹', startFunction: startStarCatcher }, { name: 'è¨˜æ†¶æ˜Ÿè»Œ', startFunction: startMemoryTrail }, { name: 'å¤¢å¢ƒé‡£é­š', startFunction: startDreamFishing }, { name: 'æƒ…ç·’æ•´ç†', startFunction: startTidyEmotions }, { name: 'å¤¢å¢ƒç·¨ç¹”', startFunction: startDreamWeaving } ];
    const badDreams = [ { name: 'å¤¢é­˜æ™è„«', startFunction: startNightmareEscape }, { name: 'è¿·å®®å²”è·¯', startFunction: startMazeQTE }, { name: 'èº²é¿é™°å½±', startFunction: startDodgeShadows }, { name: 'é¬¼å£“åºŠ', startFunction: startSleepParalysis } ];
    const fortunes = [
        { name: 'å¤§å‰', color: '#ff4757', tagline: 'ä»Šå¤©å°‡æ˜¯ç„¡èˆ‡å€«æ¯”çš„ä¸€å¤©ï¼', effect: () => { const bonus = 50 + 10 * pillowLevel; money += bonus; return `ç²å¾—äº† ${bonus} ğŸ’° çš„æ„å¤–ä¹‹è²¡ï¼`; } },
        { name: 'ä¸­å‰', color: '#ffa502', tagline: 'å¥½é‹æ­£åœ¨å‘ä½ æ‹›æ‰‹ã€‚', effect: () => { goodDreamChance = Math.min(95, goodDreamChance + 10); return `ä¸‹æ¬¡å…¥ç¡çš„å¥½å¤¢æ©Ÿç‡æå‡10%ï¼`; } },
        { name: 'å°å‰', color: '#2ed573', tagline: 'å¾®å°çš„å¹¸é‹ï¼Œä¹Ÿèƒ½å¸¶ä¾†å¿«æ¨‚ã€‚', effect: () => { const bonus = 20 + 5 * pillowLevel; money += bonus; return `æ’¿åˆ°äº† ${bonus} ğŸ’°ï¼`; } },
        { name: 'å…‡', color: '#5352ed', tagline: 'çƒé›²ç± ç½©...çœ‹ä¾†è¦å°å¿ƒè¡Œäº‹ã€‚', effect: () => { const loss = 15 * bedLevel; money = Math.max(0, money - loss); return `ä¸å°å¿ƒéºå¤±äº† ${loss} ğŸ’°...`; } },
        { name: 'å¤§å…‡', color: '#1e272e', tagline: 'è«¸äº‹ä¸é †ï¼Œç ´è²¡ä¹‹ç›¸ï¼', effect: () => { money = Math.floor(money * 0.8); return `é­é‡è¿é ­ç—›æ“Šï¼Œæå¤±äº†20%çš„è²¡ç”¢ï¼`; } }
    ];

    // --- 2. å…ƒç´ è®Šæ•¸å®£å‘Š ---
    let gameContainer, moneyEl, goodDreamChanceEl, gameLogEl, sleepButton, bedLevelEl, pillowLevelEl, bedUpgradeCostEl, pillowUpgradeCostEl, upgradeBedButton, upgradePillowButton, minigameModal, minigameTitle, minigameInstruction, minigameInfoBar, minigameArea, minigameResultEl, eventModal, eventResultEl, cardContainer, dreamCatcherLevelEl, dreamCatcherUpgradeCostEl, upgradeDreamCatcherButton, incenseLevelEl, incenseUpgradeCostEl, upgradeIncenseButton, goodDreamItemCountEl, badDreamItemCountEl, goodDreamItemCostEl, badDreamItemCostEl, buyGoodDreamItemButton, buyBadDreamItemButton;

    // --- 3. æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ---
    function logMessage(message) { const p = document.createElement('p'); p.innerHTML = message; gameLogEl.appendChild(p); gameLogEl.scrollTop = gameLogEl.scrollHeight; }
    
    function updateStatsUI() { 
        moneyEl.textContent = money; goodDreamChanceEl.textContent = goodDreamChance; 
        bedLevelEl.textContent = bedLevel; pillowLevelEl.textContent = pillowLevel; dreamCatcherLevelEl.textContent = dreamCatcherLevel; incenseLevelEl.textContent = incenseLevel;
        bedUpgradeCostEl.textContent = bedUpgradeCost; pillowUpgradeCostEl.textContent = pillowUpgradeCost; dreamCatcherUpgradeCostEl.textContent = dreamCatcherUpgradeCost; incenseUpgradeCostEl.textContent = incenseUpgradeCost;
        goodDreamItemCountEl.textContent = guaranteedGoodDreams; badDreamItemCountEl.textContent = guaranteedBadDreams;
        goodDreamItemCostEl.textContent = goodDreamItemCost; badDreamItemCostEl.textContent = badDreamItemCost;

        const buttonsDisabled = minigameActive || eventActive;
        sleepButton.disabled = buttonsDisabled; 
        upgradeBedButton.disabled = money < bedUpgradeCost || buttonsDisabled; 
        upgradePillowButton.disabled = money < pillowUpgradeCost || buttonsDisabled; 
        upgradeDreamCatcherButton.disabled = money < dreamCatcherUpgradeCost || buttonsDisabled;
        upgradeIncenseButton.disabled = money < incenseUpgradeCost || buttonsDisabled;
        buyGoodDreamItemButton.disabled = money < goodDreamItemCost || buttonsDisabled;
        buyBadDreamItemButton.disabled = money < badDreamItemCost || buttonsDisabled;
    }
    
    function goToSleep() {
        let isGoodDream;
        if (guaranteedGoodDreams > 0) {
            isGoodDream = true;
            guaranteedGoodDreams--;
            logMessage("ğŸ€ ä½ ä½¿ç”¨äº†å¹¸é‹å››è‘‰è‰ï¼Œä¸€é™£æº«æš–çš„ç¡æ„åŒ…åœäº†ä½ ...");
        } else if (guaranteedBadDreams > 0) {
            isGoodDream = false;
            guaranteedBadDreams--;
            logMessage("ğŸ ä½ æ‹¿å‡ºäº†è©›å’’å¨ƒå¨ƒï¼Œç©ºæ°£ä¼¼ä¹è®Šå¾—å†°å†·è€Œæ²‰é‡...");
        } else {
            isGoodDream = Math.random() * 100 < goodDreamChance;
        }
        
        minigameActive = true; 
        saveGame();
        updateStatsUI(); 
        logMessage("ä½ ç·©ç·©é–‰ä¸Šçœ¼ç›ï¼Œé€²å…¥äº†å¤¢é„‰..."); 

        setTimeout(() => { 
            const dreamPool = isGoodDream ? goodDreams : badDreams; 
            const selectedDream = dreamPool[Math.floor(Math.random() * dreamPool.length)]; 
            selectedDream.startFunction(); 
        }, 1500); 
    }

    function clearTimersAndListeners() { clearInterval(gameInterval); clearTimeout(gameTimeout); if (keydownHandler) document.removeEventListener('keydown', keydownHandler); if (keyupHandler) document.removeEventListener('keyup', keyupHandler); if (mousemoveHandler) minigameArea.removeEventListener('mousemove', mousemoveHandler); keydownHandler = null; keyupHandler = null; mousemoveHandler = null; gameInterval = null; gameTimeout = null; }
    function showMinigame() { gameContainer.classList.add('frozen'); minigameModal.classList.remove('hidden'); minigameResultEl.innerHTML = ''; minigameInfoBar.innerHTML = ''; minigameArea.innerHTML = ''; minigameInstruction.textContent = ''; minigameArea.style.pointerEvents = 'auto'; }
    function hideMinigame() { gameContainer.classList.remove('frozen'); minigameModal.classList.add('hidden'); if (!eventActive) { minigameActive = false; updateStatsUI(); } }
    
    function showEndScreen(resultText, logText, success) { 
        if (!minigameActive) return; 
        let gameJustEnded = true; 
        minigameActive = false; 
        clearTimersAndListeners(); 
        minigameArea.style.pointerEvents = 'none'; 
        minigameResultEl.textContent = resultText; 
        minigameResultEl.style.color = success === false ? 'var(--bad-color)' : success === true ? 'var(--good-color)' : 'var(--neutral-color)'; 
        if (logText) logMessage(logText); 
        
        saveGame(); // å¤¢å¢ƒçµæŸå¾Œå„²å­˜éŠæˆ²ç‹€æ…‹
        
        const EVENT_CHANCE = 0.3; 
        if (Math.random() < EVENT_CHANCE) { 
            setTimeout(() => startFortuneEvent(gameJustEnded), 2000); 
        } else { 
            setTimeout(() => { if (gameJustEnded) hideMinigame(); }, 3000); 
        } 
    }
    
    function upgradeBed() { if (money >= bedUpgradeCost) { money -= bedUpgradeCost; bedLevel++; goodDreamChance = Math.min(95, goodDreamChance + 5); bedUpgradeCost = Math.floor(bedUpgradeCost * 1.6); logMessage(`ğŸ› ï¸ åºŠå‡ç´šäº†ï¼ç­‰ç´š ${bedLevel}ï¼Œå¥½å¤¢æ©Ÿç‡æå‡è‡³ ${goodDreamChance}%ã€‚`); saveGameAndUpdateUI(); } }
    function upgradePillow() { if (money >= pillowUpgradeCost) { money -= pillowUpgradeCost; pillowLevel++; pillowUpgradeCost = Math.floor(pillowUpgradeCost * 1.7); logMessage(`ğŸ› ï¸ æ•é ­å‡ç´šäº†ï¼ç­‰ç´š ${pillowLevel}ï¼Œé‡‘éŒ¢ç²å–é‡æå‡ã€‚`); saveGameAndUpdateUI(); } }
    function upgradeDreamCatcher() { if (money >= dreamCatcherUpgradeCost) { money -= dreamCatcherUpgradeCost; dreamCatcherLevel++; dreamCatcherUpgradeCost = Math.floor(dreamCatcherUpgradeCost * 1.8); logMessage(`ğŸ› ï¸ æ•å¤¢ç¶²å‡ç´šäº†ï¼ç­‰ç´š ${dreamCatcherLevel}ï¼Œèƒ½æŠµç¦¦æ›´å¤šå£å¤¢æå¤±ã€‚`); saveGameAndUpdateUI(); } }
    function upgradeIncense() { if (money >= incenseUpgradeCost) { money -= incenseUpgradeCost; incenseLevel++; incenseUpgradeCost = Math.floor(incenseUpgradeCost * 1.75); logMessage(`ğŸ› ï¸ å¯§ç¥è–°é¦™å‡ç´šäº†ï¼ç­‰ç´š ${incenseLevel}ï¼Œå¤¢å¢ƒè®Šå¾—æ›´å®‰ç©©ã€‚`); saveGameAndUpdateUI(); } }
    
    function buyGoodDreamItem() { if (money >= goodDreamItemCost) { money -= goodDreamItemCost; guaranteedGoodDreams++; logMessage("ğŸ›ï¸ ä½ è³¼è²·äº†ä¸€æ ªå¹¸é‹å››è‘‰è‰ï¼"); saveGameAndUpdateUI(); } }
    function buyBadDreamItem() { if (money >= badDreamItemCost) { money -= badDreamItemCost; guaranteedBadDreams++; logMessage("ğŸ›ï¸ ä½ è³¼è²·äº†ä¸€å€‹è©­ç•°çš„è©›å’’å¨ƒå¨ƒ..."); saveGameAndUpdateUI(); } }

    function startFortuneEvent(gameJustEnded) { eventActive = true; updateStatsUI(); eventModal.classList.remove('hidden'); cardContainer.innerHTML = ''; eventResultEl.textContent = ''; const shuffledFortunes = [...fortunes].sort(() => 0.5 - Math.random()); const selectedFortunes = shuffledFortunes.slice(0, 3); selectedFortunes.forEach(fortune => { const card = document.createElement('div'); card.className = 'card'; const cardInner = document.createElement('div'); cardInner.className = 'card-inner'; const cardBack = document.createElement('div'); cardBack.className = 'card-face card-back'; cardBack.textContent = 'â“'; const cardFront = document.createElement('div'); cardFront.className = 'card-face card-front'; cardFront.innerHTML = `<div class="fortune-name" style="color:${fortune.color};">${fortune.name}</div><div class="fortune-tagline">${fortune.tagline}</div>`; cardInner.appendChild(cardBack); cardInner.appendChild(cardFront); card.appendChild(cardInner); card.onclick = () => flipCard(card, fortune); cardContainer.appendChild(card); }); }
    
    function flipCard(clickedCard, chosenFortune) { 
        document.querySelectorAll('.card').forEach(c => c.onclick = null); 
        clickedCard.classList.add('is-flipped'); 
        const effectMessage = chosenFortune.effect(); 
        logMessage(`ã€é‹å‹¢ï¼š${chosenFortune.name}ã€‘${chosenFortune.tagline} ${effectMessage}`); 
        eventResultEl.textContent = effectMessage; 
        
        saveGameAndUpdateUI(); // å¡ç‰Œæ•ˆæœå¯èƒ½æ”¹è®Šç‹€æ…‹ï¼Œæ‰€ä»¥å„²å­˜
        
        setTimeout(() => { document.querySelectorAll('.card:not(.is-flipped)').forEach(otherCard => { otherCard.classList.add('is-flipped'); }); }, 1000); 
        setTimeout(() => { eventModal.classList.add('hidden'); eventActive = false; hideMinigame(); }, 4000); 
    }

    // --- 4. å­˜æª”ç³»çµ± ---
    function saveGame() {
        const gameState = {
            money, goodDreamChance, bedLevel, pillowLevel, dreamCatcherLevel, incenseLevel,
            bedUpgradeCost, pillowUpgradeCost, dreamCatcherUpgradeCost, incenseUpgradeCost,
            guaranteedGoodDreams, guaranteedBadDreams
        };
        localStorage.setItem('dreamGameSaveData', JSON.stringify(gameState));
    }

    function loadGame() {
        const savedData = localStorage.getItem('dreamGameSaveData');
        if (savedData) {
            const gameState = JSON.parse(savedData);
            money = gameState.money || 0;
            goodDreamChance = gameState.goodDreamChance || 50;
            bedLevel = gameState.bedLevel || 1;
            pillowLevel = gameState.pillowLevel || 1;
            dreamCatcherLevel = gameState.dreamCatcherLevel || 1;
            incenseLevel = gameState.incenseLevel || 1;
            bedUpgradeCost = gameState.bedUpgradeCost || 50;
            pillowUpgradeCost = gameState.pillowUpgradeCost || 70;
            dreamCatcherUpgradeCost = gameState.dreamCatcherUpgradeCost || 100;
            incenseUpgradeCost = gameState.incenseUpgradeCost || 120;
            guaranteedGoodDreams = gameState.guaranteedGoodDreams || 0;
            guaranteedBadDreams = gameState.guaranteedBadDreams || 0;
            logMessage("ğŸ’¾ è®€å–å­˜æª”æˆåŠŸï¼æ­¡è¿å›ä¾†ã€‚");
        } else {
            // åˆå§‹åŒ–æ–°éŠæˆ²
            money = 0; goodDreamChance = 50; bedLevel = 1; pillowLevel = 1; dreamCatcherLevel = 1; incenseLevel = 1;
            bedUpgradeCost = 50; pillowUpgradeCost = 70; dreamCatcherUpgradeCost = 100; incenseUpgradeCost = 120;
            guaranteedGoodDreams = 0; guaranteedBadDreams = 0;
            logMessage("æ­¡è¿ä¾†åˆ°å¤¢å¢ƒéŠæˆ²ï¼ä»Šæ™šæœƒæ˜¯ä»€éº¼å¤¢å‘¢ï¼Ÿ");
        }
    }
    
    function saveGameAndUpdateUI() {
        saveGame();
        updateStatsUI();
    }

    // --- 5. æ‰€æœ‰å°éŠæˆ²å®Œæ•´é‚è¼¯ (æ­¤è™•ç¨‹å¼ç¢¼èˆ‡å‰ä¸€ç‰ˆç›¸åŒï¼Œç‚ºç¯€çœç¯‡å¹…å·²æŠ˜ç–Š) ---
    function startStarCatcher() { let score = 0; let duration = 7 + (incenseLevel - 1); showMinigame(); minigameTitle.textContent = "âœ¨ æ˜Ÿå…‰æ•æ‰‹ âœ¨"; minigameInstruction.textContent = "åœ¨æ™‚é–“å…§ç›¡å¯èƒ½é»æ“Šå‡ºç¾çš„æ˜Ÿæ˜Ÿï¼"; minigameInfoBar.innerHTML = `<span>æ™‚é–“: <span id="timer">${duration}</span>s</span> <span>åˆ†æ•¸: <span id="score">0</span></span>`; const timerEl = document.getElementById('timer'); const scoreEl = document.getElementById('score'); const starSpawner = setInterval(() => { if (!minigameActive) { clearInterval(starSpawner); return; } const star = document.createElement('div'); star.textContent = 'â­'; star.className = 'star'; star.style.top = `${Math.random() * 85}%`; star.style.left = `${Math.random() * 90}%`; star.onclick = () => { if(!minigameActive) return; score++; scoreEl.textContent = score; star.onclick = null; star.classList.add('popped'); setTimeout(() => star.remove(), 300); }; minigameArea.appendChild(star); }, 500); gameInterval = setInterval(() => { duration--; timerEl.textContent = duration; if (duration <= 0) { clearInterval(gameInterval); clearInterval(starSpawner); endStarCatcher(score); } }, 1000); }
    function endStarCatcher(finalScore) { const earnings = finalScore * pillowLevel * 2; money += earnings; showEndScreen(`æŠ“åˆ°äº† ${finalScore} é¡†æ˜Ÿæ˜Ÿï¼ç²å¾— ${earnings} ğŸ’°ï¼`, `ğŸŒ™ å¥½å¤¢ä¸­æŠ“åˆ° ${finalScore} é¡†æ˜Ÿæ˜Ÿï¼Œç²å¾— ${earnings} ğŸ’°ï¼`, true); }
    function startNightmareEscape() { let clicks = 0; let duration = 4; showMinigame(); minigameTitle.textContent = "ğŸ‘» å¤¢é­˜æ™è„« ğŸ‘»"; minigameInstruction.textContent = "å¿«ï¼ç˜‹ç‹‚é»æ“ŠæŒ‰éˆ•å¾å¤¢é­˜ä¸­æ™è„«ï¼"; minigameInfoBar.innerHTML = `<span>æ™‚é–“: <span id="timer">${duration}</span>s</span> <span>é»æ“Š: <span id="score">0</span></span>`; const timerEl = document.getElementById('timer'); const scoreEl = document.getElementById('score'); minigameArea.innerHTML = `<button id="mash-button" style="width: 80%; height: 80px; font-size: 1.5em; background-color: var(--bad-color);">æ™è„«ï¼</button>`; document.getElementById('mash-button').onclick = () => { if(!minigameActive) return; clicks++; scoreEl.textContent = clicks; }; gameInterval = setInterval(() => { duration--; timerEl.textContent = duration; if (duration <= 0) { clearInterval(gameInterval); endNightmareEscape(clicks); } }, 1000); }
    function endNightmareEscape(finalClicks) { const threshold = 15 + bedLevel - (incenseLevel - 1); let moneyLost = 0; const lossReduction = 1 - (dreamCatcherLevel - 1) * 0.1; if (finalClicks >= threshold) { moneyLost = Math.round(5 * pillowLevel * lossReduction); money = Math.max(0, money - moneyLost); showEndScreen(`æˆåŠŸæ™è„«äº†ï¼ä½†é‚„æ˜¯æå¤±äº† ${moneyLost} ğŸ’°ã€‚`, `ğŸ‘» æˆåŠŸæ™è„«å£å¤¢ï¼Œæå¤± ${moneyLost} ğŸ’°ã€‚`, true); } else { moneyLost = Math.round(15 * pillowLevel * lossReduction); money = Math.max(0, money - moneyLost); showEndScreen(`è¢«å¤¢é­˜åå™¬äº†...æå¤±äº† ${moneyLost} ğŸ’°ï¼`, `ğŸ‘» è¢«å£å¤¢æ“Šæ•—ï¼Œæå¤± ${moneyLost} ğŸ’°ã€‚`, false); } }
    function startMemoryTrail() { let sequence = [], playerSequence = [], level = 1; showMinigame(); minigameTitle.textContent = "âœ¨ è¨˜æ†¶æ˜Ÿè»Œ âœ¨"; minigameInstruction.textContent = "è¨˜ä½æ˜Ÿæ˜Ÿé–ƒçˆçš„é †åºä¸¦ä¾åºé»æ“Šã€‚"; minigameInfoBar.innerHTML = `<span>é•·åº¦: <span id="score">1</span></span>`; const scoreEl = document.getElementById('score'); function nextLevel() { minigameArea.style.pointerEvents = 'none'; minigameArea.innerHTML = '<p style="font-size: 1.5em;">è«‹è¨˜ä½é †åº...</p>'; playerSequence = []; scoreEl.textContent = level; setTimeout(() => { if(!minigameActive && !eventActive) return; minigameArea.innerHTML = ''; let positions = []; for (let i = 0; i < level; i++) { positions.push({ top: `${10 + Math.random() * 80}%`, left: `${10 + Math.random() * 80}%` }); } sequence = positions.map((pos, index) => { const star = document.createElement('div'); star.className = 'memory-star'; star.textContent = 'âœ§'; star.style.top = pos.top; star.style.left = pos.left; star.dataset.index = index; star.onclick = () => playerClick(star); minigameArea.appendChild(star); return star; }); setTimeout(() => minigameArea.style.pointerEvents = 'auto', level * 800); sequence.forEach((star, index) => { setTimeout(() => { star.classList.add('highlight'); setTimeout(() => star.classList.remove('highlight'), 500); }, (index + 1) * 800); }); }, 1500); } function playerClick(clickedStar) { if (playerSequence.length >= sequence.length || !minigameActive) return; const clickedIndex = parseInt(clickedStar.dataset.index); if (sequence[playerSequence.length].dataset.index != clickedIndex) { clickedStar.classList.add('wrong'); endMemoryTrail(level - 1, sequence); return; } playerSequence.push(clickedIndex); clickedStar.classList.add('highlight'); if (playerSequence.length === sequence.length) { level++; setTimeout(nextLevel, 1000); } } nextLevel(); }
    function endMemoryTrail(finalLevel, correctSequence) { if (correctSequence) { correctSequence.forEach((star, index) => { setTimeout(() => star.classList.add('correct-path'), index * 100); }); } const earnings = finalLevel * finalLevel * pillowLevel * 2; money += earnings; showEndScreen(`è¨˜æ†¶ä¸­æ–·ï¼ä½ è¨˜ä½äº† ${finalLevel} å€‹ç¯€é»ã€‚ç²å¾— ${earnings} ğŸ’°ï¼`, `ä½ åœ¨è¨˜æ†¶æ˜Ÿè»Œä¸­é”åˆ°äº†é•·åº¦ ${finalLevel}ï¼Œç²å¾— ${earnings} ğŸ’°ã€‚`, finalLevel > 0); }
    function startDreamFishing() { showMinigame(); minigameTitle.textContent = "ğŸ£ å¤¢å¢ƒé‡£é­š ğŸ£"; minigameInstruction.textContent = "åœ¨é­šæ¸¸åˆ°ä¸­é–“é‡£ç·šä¸‹æ–¹æ™‚ï¼Œé»æ“Šç•«é¢ï¼"; const fish = document.createElement('div'); fish.textContent = 'ğŸŸ'; fish.className = 'fish'; fish.style.top = `${30 + Math.random() * 50}%`; const moveDuration = 2 + Math.random() * 2; fish.style.animation = `moveFish ${moveDuration}s linear infinite alternate`; minigameArea.appendChild(fish); const style = document.createElement('style'); style.innerHTML = `@keyframes moveFish { 0% { left: 5%; transform: scaleX(1); } 49% {transform: scaleX(1);} 50% {transform: scaleX(-1);} 100% { left: 85%; transform: scaleX(-1);} }`; document.head.appendChild(style); minigameArea.onclick = () => { minigameArea.onclick = null; fish.style.animationPlayState = 'paused'; const line = document.createElement('div'); line.className = 'fishing-line'; minigameArea.appendChild(line); setTimeout(() => line.style.height = '100%', 50); setTimeout(() => { if(!minigameActive && !eventActive) return; const fishRect = fish.getBoundingClientRect(); const areaRect = minigameArea.getBoundingClientRect(); const lineX = areaRect.left + (areaRect.width / 2); document.head.removeChild(style); const success = lineX > fishRect.left && lineX < fishRect.right; if (success) fish.classList.add('popped'); endDreamFishing(success); }, 500); }; }
    function endDreamFishing(success) { if (success) { const earnings = 50 * pillowLevel; money += earnings; showEndScreen(`é‡£åˆ°äº†ï¼ä¸€æ¢é‡‘å…‰é–ƒé–ƒçš„é­šï¼ç²å¾— ${earnings} ğŸ’°ï¼`, `æˆåŠŸé‡£åˆ°å¤¢å¢ƒé‡‘é­šï¼Œç²å¾— ${earnings} ğŸ’°ã€‚`, true); } else { showEndScreen(`å“å‘€ï¼Œè®“å®ƒçµ¦æºœäº†ï¼`, `å¤¢å¢ƒé‡‘é­šé€ƒèµ°äº†ï¼Œä¸€ç„¡æ‰€ç²ã€‚`, 'neutral'); } }
    function startTidyEmotions() { let score = 0; let duration = 8 + (incenseLevel - 1); showMinigame(); minigameTitle.textContent = "ğŸ˜Š æ•´ç†æƒ…ç·’ ğŸ˜­"; minigameInstruction.textContent = "é»æ“Šç¬‘è‡‰ (ğŸ˜Š) åŠ åˆ†ï¼Œé¿é–‹å“­è‡‰ (ğŸ˜­)ï¼"; minigameInfoBar.innerHTML = `<span>æ™‚é–“: <span id="timer">${duration}</span>s</span> <span>åˆ†æ•¸: <span id="score">0</span></span>`; const timerEl = document.getElementById('timer'); const scoreEl = document.getElementById('score'); const iconSpawner = setInterval(() => { if (!minigameActive) { clearInterval(iconSpawner); return; } const isGood = Math.random() > 0.4; const icon = document.createElement('div'); icon.className = 'emotion-icon'; icon.textContent = isGood ? 'ğŸ˜Š' : 'ğŸ˜­'; icon.style.left = `${Math.random() * 90}%`; icon.style.animationDuration = `${2 + Math.random() * 2}s`; icon.onclick = () => { if(!minigameActive) return; score += isGood ? 1 : -2; scoreEl.textContent = score; icon.onclick = null; icon.classList.add('popped'); setTimeout(() => icon.remove(), 300); }; minigameArea.appendChild(icon); setTimeout(() => icon.remove(), 4000); }, 600); gameInterval = setInterval(() => { duration--; timerEl.textContent = duration; if (duration <= 0) { clearInterval(gameInterval); clearInterval(iconSpawner); endTidyEmotions(score); } }, 1000); }
    function endTidyEmotions(finalScore) { const earnings = finalScore * pillowLevel * 3; money = Math.max(0, money + earnings); if (earnings > 0) { showEndScreen(`æ•´ç†å®Œç•¢ï¼å¿ƒæƒ…è®Šå¥½äº†ã€‚ç²å¾—äº† ${earnings} ğŸ’°ã€‚`, `ä½ æ•´ç†äº†æƒ…ç·’ï¼Œç²å¾— ${earnings} ğŸ’°ã€‚`, true); } else { showEndScreen(`æ•´ç†å¤±æ•—ï¼Œå¿ƒæƒ…æ›´äº‚äº†...æå¤±äº† ${-earnings} ğŸ’°ã€‚`, `æ•´ç†æƒ…ç·’å¤±æ•—ï¼Œæå¤± ${-earnings} ğŸ’°ã€‚`, false); } }
    function startMazeQTE() { showMinigame(); minigameTitle.textContent = "ğŸ‘» è¿·å®®å²”è·¯ ğŸ‘»"; minigameInstruction.textContent = "å¿«ï¼åœ¨æ™‚é–“å…§æŒ‰ä¸‹å°æ‡‰çš„æ–¹å‘éµï¼"; minigameArea.innerHTML = `<div id="qte-arrow" style="font-size: 8em; color: yellow; text-shadow: 0 0 10px black;"></div><div id="qte-timer-bar-container"><div id="qte-timer-bar"></div></div>`; const qteArrow = document.getElementById('qte-arrow'); const timerBar = document.getElementById('qte-timer-bar'); const arrows = { 'ArrowUp': 'â¬†ï¸', 'ArrowDown': 'â¬‡ï¸', 'ArrowLeft': 'â¬…ï¸', 'ArrowRight': 'â¡ï¸' }; const keys = Object.keys(arrows); const correctKey = keys[Math.random() * keys.length | 0]; qteArrow.textContent = arrows[correctKey]; setTimeout(() => { timerBar.style.width = '0%'; }, 100); gameTimeout = setTimeout(() => endMazeQTE(false), 2000); keydownHandler = (e) => { if (keys.includes(e.key)) { e.preventDefault(); endMazeQTE(e.key === correctKey); } }; document.addEventListener('keydown', keydownHandler); }
    function endMazeQTE(success) { const flash = document.createElement('div'); flash.className = 'screen-flash'; flash.style.backgroundColor = success ? 'rgba(144, 238, 144, 0.5)' : 'rgba(255, 99, 71, 0.5)'; document.body.appendChild(flash); setTimeout(() => flash.remove(), 400); if (success) { showEndScreen("é¸å°äº†è·¯ï¼æš«æ™‚å®‰å…¨äº†ã€‚", "åœ¨è¿·å®®ä¸­é¸å°äº†æ–¹å‘ï¼Œæœ‰é©šç„¡éšªã€‚", true); } else { const moneyLost = Math.round(20 * pillowLevel * (1 - (dreamCatcherLevel - 1) * 0.1)); money = Math.max(0, money - moneyLost); showEndScreen(`æ˜¯æ­»è·¯ï¼ä½ è¿·å¤±åœ¨å…¶ä¸­...æå¤±äº† ${moneyLost} ğŸ’°ã€‚`, `åœ¨è¿·å®®ä¸­èµ°éŒ¯äº†è·¯ï¼Œæå¤± ${moneyLost} ğŸ’°ã€‚`, false); } }
    function startDodgeShadows() { let duration = 10; showMinigame(); minigameTitle.textContent = "ğŸ‘» èº²é¿é™°å½± ğŸ‘»"; minigameInstruction.textContent = "ç§»å‹•æ»‘é¼ ï¼Œæ§åˆ¶å…‰çƒèº²é¿æ‰è½çš„é™°å½±ï¼"; minigameInfoBar.innerHTML = `<span>æ’ä½: <span id="timer">${duration}</span>s</span>`; const timerEl = document.getElementById('timer'); const player = document.createElement('div'); player.id = 'player-avatar'; minigameArea.appendChild(player); mousemoveHandler = (e) => { const areaRect = minigameArea.getBoundingClientRect(); player.style.left = `${e.clientX - areaRect.left - player.offsetWidth / 2}px`; }; minigameArea.addEventListener('mousemove', mousemoveHandler); const shadowSpawner = setInterval(() => { if (!minigameActive) { clearInterval(shadowSpawner); return; } const shadow = document.createElement('div'); shadow.className = 'shadow-obstacle'; shadow.style.left = `${Math.random() * 90}%`; shadow.style.animationDuration = `${1.2 + Math.random()}s`; minigameArea.appendChild(shadow); const checkCollision = setInterval(() => { if (!minigameActive) { clearInterval(checkCollision); return; } const playerRect = player.getBoundingClientRect(); const shadowRect = shadow.getBoundingClientRect(); if (playerRect.left < shadowRect.right && playerRect.right > shadowRect.left && playerRect.top < shadowRect.bottom && playerRect.bottom > shadowRect.top) { clearInterval(checkCollision); endDodgeShadows(false); } }, 50); setTimeout(() => { clearInterval(checkCollision); shadow.remove(); }, 2200); }, 400); gameInterval = setInterval(() => { duration--; timerEl.textContent = duration; if (duration <= 0) { clearInterval(gameInterval); clearInterval(shadowSpawner); endDodgeShadows(true); } }, 1000); }
    function endDodgeShadows(survived) { if (!minigameActive) return; if (survived) { showEndScreen("ä½ æˆåŠŸæ´»äº†ä¸‹ä¾†ï¼å¤©äº®äº†ã€‚", "ä½ åœ¨é™°å½±ä¸­å­˜æ´»äº†ä¸‹ä¾†ï¼Œæ¯«é«®ç„¡å‚·ã€‚", true); } else { const moneyLost = Math.round(25 * pillowLevel * (1 - (dreamCatcherLevel - 1) * 0.1)); money = Math.max(0, money - moneyLost); showEndScreen(`è¢«é™°å½±æŠ“ä½äº†ï¼æå¤±äº† ${moneyLost} ğŸ’°ã€‚`, `ä½ è¢«é™°å½±åå™¬ï¼Œæå¤±äº† ${moneyLost} ğŸ’°ã€‚`, false); } }
    function startDreamWeaving() { let score = 0; let duration = 15 + (incenseLevel - 1); let currentLevel = 0; let requiredClicks = 0; let lastClicked = null; showMinigame(); minigameTitle.textContent = "âœ¨ å¤¢å¢ƒç·¨ç¹” âœ¨"; minigameInstruction.textContent = "ä¾åºé»æ“Šæ•¸å­—ï¼Œå°‡å¤¢å¢ƒç¢ç‰‡é€£æ¥èµ·ä¾†ã€‚"; minigameInfoBar.innerHTML = `<span>æ™‚é–“: <span id="timer">${duration}</span>s</span> <span>åˆ†æ•¸: <span id="score">0</span></span>`; const timerEl = document.getElementById('timer'); const scoreEl = document.getElementById('score'); function nextLevel() { minigameArea.innerHTML = ''; lastClicked = null; currentLevel++; requiredClicks = 0; const numFragments = 2 + currentLevel; for (let i = 1; i <= numFragments; i++) { const fragment = document.createElement('div'); fragment.className = 'dream-fragment'; fragment.textContent = i; fragment.style.top = `${10 + Math.random() * 75}%`; fragment.style.left = `${10 + Math.random() * 80}%`; fragment.onclick = () => onFragmentClick(fragment, i); minigameArea.appendChild(fragment); } } function onFragmentClick(element, num) { if (!minigameActive || num !== requiredClicks + 1) return; requiredClicks++; element.classList.add('clicked'); element.onclick = null; if (lastClicked) { /* å¯é¸ï¼šç•«ç·š */ } lastClicked = element; if (requiredClicks === (2 + currentLevel)) { score++; scoreEl.textContent = score; nextLevel(); } } gameInterval = setInterval(() => { duration--; timerEl.textContent = duration; if (duration <= 0) { clearInterval(gameInterval); endDreamWeaving(score); } }, 1000); nextLevel(); }
    function endDreamWeaving(finalScore) { const earnings = finalScore * finalScore * pillowLevel * 2; money += earnings; showEndScreen(`ç·¨ç¹”å®Œæˆï¼ä½ å®Œæˆäº† ${finalScore} å€‹æ˜Ÿåº§ã€‚ç²å¾— ${earnings} ğŸ’°ï¼`, `ä½ åœ¨å¤¢ä¸­ç·¨ç¹”äº† ${finalScore} å€‹æ˜Ÿåº§ï¼Œç²å¾— ${earnings} ğŸ’°ã€‚`, true); }
    function startSleepParalysis() { let progress = 0; let duration = 10; let isHolding = false; showMinigame(); minigameTitle.textContent = "ğŸ‘» é¬¼å£“åºŠ ğŸ‘»"; minigameInstruction.textContent = "æŒ‰ä½ [ç©ºç™½éµ] ä¾†ç©è“„æ„å¿—åŠ›ï¼Œä½†è¦é¿é–‹ææ‡¼çš„è„ˆè¡ï¼"; minigameInfoBar.innerHTML = `<span>å‰©é¤˜æ™‚é–“: <span id="timer">${duration}</span>s</span>`; minigameArea.innerHTML = '<div id="paralysis-bar-container"><div id="paralysis-bar"></div></div><div id="paralysis-pulse"></div>'; const timerEl = document.getElementById('timer'); const bar = document.getElementById('paralysis-bar'); const pulse = document.getElementById('paralysis-pulse'); let isPulsing = false; const pulseCheck = setInterval(() => { isPulsing = parseFloat(getComputedStyle(pulse).opacity) > 0.5; }, 50); keydownHandler = e => { if (e.code === 'Space' && !isHolding) { isHolding = true; } }; keyupHandler = e => { if (e.code === 'Space') { isHolding = false; } }; document.addEventListener('keydown', keydownHandler); document.addEventListener('keyup', keyupHandler); gameInterval = setInterval(() => { if (isHolding) { if (isPulsing) { progress -= 10; } else { progress += 2.5 + (incenseLevel - 1) * 0.2; } } else { progress -= 0.5; } progress = Math.max(0, Math.min(100, progress)); bar.style.width = `${progress}%`; if (progress >= 100) { clearInterval(gameInterval); clearInterval(pulseCheck); endSleepParalysis(true); return; } duration -= 0.05; timerEl.textContent = Math.ceil(duration); if (duration <= 0) { clearInterval(gameInterval); clearInterval(pulseCheck); endSleepParalysis(false); } }, 50); }
    function endSleepParalysis(success) { if (success) { showEndScreen("ä½ æˆ°å‹äº†ææ‡¼ï¼ŒæˆåŠŸé†’ä¾†ï¼", "ä½ å¾é¬¼å£“åºŠä¸­æˆåŠŸæ™è„«ï¼Œæœ‰é©šç„¡éšªã€‚", true); } else { const moneyLost = Math.round(30 * pillowLevel * (1 - (dreamCatcherLevel - 1) * 0.1)); money = Math.max(0, money - moneyLost); showEndScreen(`æ„å¿—åŠ›è€—ç›¡...ä½ è¢«å›°åœ¨äº†ææ‡¼ä¸­ã€‚æå¤± ${moneyLost} ğŸ’°ã€‚`, `è¢«é¬¼å£“åºŠæ“Šæ•—ï¼Œæå¤±äº† ${moneyLost} ğŸ’°ã€‚`, false); } }


    // --- 6. éŠæˆ²åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        // æŠ“å–æ‰€æœ‰å…ƒç´ 
        gameContainer = document.getElementById('game-container'); moneyEl = document.getElementById('money'); goodDreamChanceEl = document.getElementById('good-dream-chance'); gameLogEl = document.getElementById('game-log'); sleepButton = document.getElementById('sleep-button'); bedLevelEl = document.getElementById('bed-level'); pillowLevelEl = document.getElementById('pillow-level'); bedUpgradeCostEl = document.getElementById('bed-upgrade-cost'); pillowUpgradeCostEl = document.getElementById('pillow-upgrade-cost'); upgradeBedButton = document.getElementById('upgrade-bed-button'); upgradePillowButton = document.getElementById('upgrade-pillow-button'); minigameModal = document.getElementById('minigame-modal'); minigameTitle = document.getElementById('minigame-title'); minigameInstruction = document.getElementById('minigame-instruction'); minigameInfoBar = document.getElementById('minigame-info-bar'); minigameArea = document.getElementById('minigame-area'); minigameResultEl = document.getElementById('minigame-result');
        eventModal = document.getElementById('event-modal'); eventResultEl = document.getElementById('event-result'); cardContainer = document.getElementById('card-container');
        dreamCatcherLevelEl = document.getElementById('dreamcatcher-level'); dreamCatcherUpgradeCostEl = document.getElementById('dreamcatcher-upgrade-cost'); upgradeDreamCatcherButton = document.getElementById('upgrade-dreamcatcher-button');
        incenseLevelEl = document.getElementById('incense-level'); incenseUpgradeCostEl = document.getElementById('incense-upgrade-cost'); upgradeIncenseButton = document.getElementById('upgrade-incense-button');
        goodDreamItemCountEl = document.getElementById('good-dream-item-count'); badDreamItemCountEl = document.getElementById('bad-dream-item-count');
        goodDreamItemCostEl = document.getElementById('good-dream-item-cost'); badDreamItemCostEl = document.getElementById('bad-dream-item-cost');
        buyGoodDreamItemButton = document.getElementById('buy-good-dream-item-button'); buyBadDreamItemButton = document.getElementById('buy-bad-dream-item-button');

        // ç¶å®šäº‹ä»¶ç›£è½å™¨
        sleepButton.addEventListener('click', goToSleep); 
        upgradeBedButton.addEventListener('click', upgradeBed); 
        upgradePillowButton.addEventListener('click', upgradePillow);
        upgradeDreamCatcherButton.addEventListener('click', upgradeDreamCatcher);
        upgradeIncenseButton.addEventListener('click', upgradeIncense);
        buyGoodDreamItemButton.addEventListener('click', buyGoodDreamItem);
        buyBadDreamItemButton.addEventListener('click', buyBadDreamItem);

        // è®€å–éŠæˆ²æˆ–åˆå§‹åŒ–
        loadGame();
        // æ›´æ–°UI
        updateStatsUI(); 
    });
    </script>
</body>
</html>```